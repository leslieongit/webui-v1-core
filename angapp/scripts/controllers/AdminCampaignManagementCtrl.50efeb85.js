app.controller("AdminCampaignsCtrl",["$q","$rootScope","CampaignSettingsService","CreateCampaignService","$scope","Geolocator","$timeout","Restangular","RestFullResponse","$translatePartialLoader","$translate","TimeStatusService","LANG","PortalSettingsService",function($q,$rootScope,CampaignSettingsService,CreateCampaignService,$scope,Geolocator,$timeout,Restangular,RestFullResponse,$translatePartialLoader,$translate,TimeStatusService,LANG,PortalSettingsService){function initializeUserObj(){$scope.user={first_name:"",last_name:"",phone:"",email:"",occupation:"",employer:"",address1:"",address2:"",city_id:"",country_id:"",reward:"",amount:"",cheque_ref:"",postal_code:"",anonymous:""}}function updateCampaignListing(sortOrFilters){RestFullResponse.all("campaign").getList(sortOrFilters).then(function(success){$scope.campaigns=success.data,$scope.campaigndata=[],$(".campaign-select-all input").each(function(){$(this).prop("checked",!1)}),$scope.getFeaturedCampaigns();var headers=success.headers();$scope.sortOrFiltersCampaign.pagination.currentpage=headers["x-pager-current-page"],$scope.sortOrFiltersCampaign.pagination.numpages=headers["x-pager-last-page"],$scope.sortOrFiltersCampaign.pagination.nextpage=headers["x-pager-next-page"],$scope.sortOrFiltersCampaign.pagination.pagesinset=headers["x-pager-pages-in-set"],$scope.sortOrFiltersCampaign.pagination.totalentries=headers["x-pager-total-entries"],$scope.sortOrFiltersCampaign.pagination.entriesperpage=headers["x-pager-entries-per-page"];var value=$translate.instant(["tab_campaign_start","tab_campaign_bank","tab_campaign_featureYes","tab_campaign_featureNo","ApprovedRunning","NotApproved","Paused","BeingEdited","ProcessingPreAuth","AceptedForCapture","DeclineForCapture","ProcessingCapture","CaptureComplete","SentForReview","Cancelled","BeingReviewed","NotFunded","tab_campaign_campaign_feature","tab_campaign_campaign_id","tab_campaign_campaign_name","tab_campaign_campaign_creator","tab_campaign_campaign_end","tab_campaign_campaign_status"]);$scope.cfeature=value.tab_campaign_campaign_feature,$scope.cid_column=value.tab_campaign_campaign_id,$scope.cname=value.tab_campaign_campaign_name,$scope.ccreator=value.tab_campaign_campaign_creator,$scope.cend=value.tab_campaign_campaign_end,$scope.cstatus=value.tab_campaign_campaign_status,$scope.startdate=value.tab_campaign_start,$scope.csvHeaders={Feature:$scope.cfeature,Id:$scope.cid_column,Name:$scope.cname,Creator:$scope.ccreator,Start:$scope.startdate,End:$scope.cend,Status:$scope.cstatus},$scope.portal_settings.site_campaign_country_funding_step&&($scope.csvHeaders.Bank=value.tab_campaign_bank),$scope.campaigndata.push($scope.csvHeaders),angular.forEach($scope.campaigns,function(values){CampaignSettingsService.setCampaignId(values.entry_id),CampaignSettingsService.processSettings(values.settings),values.settings=CampaignSettingsService.getSettings();var data2={};switch(values.featured?$scope.featurestat=value.tab_campaign_featureYes:$scope.featurestat=value.tab_campaign_featureNo,values.entry_status_id){case 1:$scope.entrystat=value.BeingEdited;break;case 2:$scope.entrystat=value.ApprovedRunning;break;case 3:$scope.entrystat=value.NotApproved;break;case 4:$scope.entrystat=value.Paused;break;case 5:$scope.entrystat=value.ProcessingPreAuth;break;case 6:$scope.entrystat=value.AceptedForCapture;break;case 7:$scope.entrystat=value.DeclineForCapture;break;case 8:$scope.entrystat=value.ProcessingCapture;break;case 9:$scope.entrystat=value.CaptureComplete;break;case 10:$scope.entrystat=value.SentForReview;break;case 11:$scope.entrystat=value.Cancelled;break;case 12:$scope.entrystat=value.BeingReviewed;break;case 13:$scope.entrystat=value.NotFunded}$scope.creator=values.managers[0].first_name+" "+values.managers[0].last_name,values.starts?$scope.startdate=values.starts.slice(0,10):$scope.startdate="",values.ends?$scope.enddate=values.ends.slice(0,10):$scope.enddate="",data2={Feature:$scope.featurestat,Id:values.id,Name:values.name,Creator:$scope.creator,Start:$scope.startdate,End:$scope.enddate,Status:$scope.entrystat},$scope.portal_settings.site_campaign_country_funding_step&&(data2.bank=JSON.stringify(values.settings.bank)),$scope.campaigndata.push(data2)})})}function createCampaignCSV(){var campaignRequestArray=[],totalNumCampaigns=$scope.sortOrFiltersCampaign.pagination.totalentries,requiredNumCalls=0;$scope.allCampaignsArray=[];var reqArg={page:1};requiredNumCalls=parseInt(parseInt(totalNumCampaigns)/100),totalNumCampaigns%100!=0&&(requiredNumCalls+=1);for(var curNumCall=0;curNumCall<requiredNumCalls;curNumCall++){var request=RestFullResponse.all("campaign").getList(reqArg);campaignRequestArray.push(request),reqArg.page+=1}return $q.all(campaignRequestArray).then(function(success){$scope.allCampaignscsv=[],$scope.allCampaignsCompletecsv=[],success.forEach(function(resArr){$scope.allCampaignsArray=$scope.allCampaignsArray.concat(resArr.data)});var value=$translate.instant(["tab_campaign_start","tab_campaign_bank"," tab_campaign_featureYes","tab_campaign_featureNo","ApprovedRunning","NotApproved","Paused","BeingEdited","ProcessingPreAuth","AceptedForCapture","DeclineForCapture","ProcessingCapture","CaptureComplete","SentForReview","Cancelled","BeingReviewed","NotFunded","tab_campaign_campaign_feature","tab_campaign_campaign_id","tab_campaign_campaign_name","tab_campaign_campaign_creator","tab_campaign_campaign_end","tab_campaign_campaign_status"]);return $scope.cfeature=value.tab_campaign_campaign_feature,$scope.cid_column=value.tab_campaign_campaign_id,$scope.cname=value.tab_campaign_campaign_name,$scope.ccreator=value.tab_campaign_campaign_creator,$scope.cend=value.tab_campaign_campaign_end,$scope.cstatus=value.tab_campaign_campaign_status,$scope.startdate=value.tab_campaign_start,$scope.csvHeaders={Feature:$scope.cfeature,Id:$scope.cid_column,Name:$scope.cname,Creator:$scope.ccreator,Start:$scope.startdate,End:$scope.cend,Status:$scope.cstatus},$scope.portal_settings.site_campaign_country_funding_step&&($scope.csvHeaders.bank=value.tab_campaign_bank),$scope.allCampaignscsv.push($scope.csvHeaders),angular.forEach($scope.allCampaignsArray,function(values){CampaignSettingsService.processSettings(values.settings),values.settings=CampaignSettingsService.getSettings();var data2={};switch(values.featured?$scope.featurestat=value.tab_campaign_featureYes:$scope.featurestat=value.tab_campaign_featureNo,values.entry_status_id){case 1:$scope.entrystat=value.BeingEdited;break;case 2:$scope.entrystat=value.ApprovedRunning;break;case 3:$scope.entrystat=value.NotApproved;break;case 4:$scope.entrystat=value.Paused;break;case 5:$scope.entrystat=value.ProcessingPreAuth;break;case 6:$scope.entrystat=value.AceptedForCapture;break;case 7:$scope.entrystat=value.DeclineForCapture;break;case 8:$scope.entrystat=value.ProcessingCapture;break;case 9:$scope.entrystat=value.CaptureComplete;break;case 10:$scope.entrystat=value.SentForReview;break;case 11:$scope.entrystat=value.Cancelled;break;case 12:$scope.entrystat=value.BeingReviewed;break;case 13:$scope.entrystat=value.NotFunded}$scope.creator=values.managers[0].first_name+" "+values.managers[0].last_name,values.starts?$scope.startdate=values.starts.slice(0,10):$scope.startdate="",values.ends?$scope.enddate=values.ends.slice(0,10):$scope.enddate="",data2={Feature:$scope.featurestat,Id:values.id,Name:values.name,Creator:$scope.creator,Start:$scope.startdate,End:$scope.enddate,Status:$scope.entrystat},$scope.portal_settings.site_campaign_country_funding_step&&(data2.bank=JSON.stringify(values.settings.bank)),$scope.allCampaignscsv.push(data2)}),$scope.allCampaignscsv})}function createCampaignCompleteCSV(){var campaignRequestArray=[],totalNumCampaigns=$scope.sortOrFiltersCampaign.pagination.totalentries,requiredNumCalls=0;$scope.allCampaignsArray=[];var reqArg={page:1};requiredNumCalls=parseInt(parseInt(totalNumCampaigns)/100),totalNumCampaigns%100!=0&&(requiredNumCalls+=1);for(var curNumCall=0;curNumCall<requiredNumCalls;curNumCall++){var request=RestFullResponse.all("campaign").getList(reqArg);campaignRequestArray.push(request),reqArg.page+=1}return $q.all(campaignRequestArray).then(function(success){$scope.allCampaignscsv=[],$scope.allCampaignsCompletecsv=[],success.forEach(function(resArr){$scope.allCampaignsArray=$scope.allCampaignsArray.concat(resArr.data)});var value=$translate.instant(["tab_campaign_start","tab_campaign_bank","tab_campaign_featureYes","tab_campaign_featureNo","ApprovedRunning","NotApproved","Paused","BeingEdited","ProcessingPreAuth","AceptedForCapture","DeclineForCapture","ProcessingCapture","CaptureComplete","SentForReview","Cancelled","BeingReviewed","NotFunded","tab_campaign_campaign_feature","tab_campaign_campaign_id","tab_campaign_campaign_name","tab_campaign_campaign_creator","tab_campaign_campaign_end","tab_campaign_campaign_status","tab_campaign_campaign_currency","tab_campaign_campaign_category","tab_campaign_campaign_business","tab_campaign_campaign_file","tab_campaign_campaign_recurring","tab_campaign_campaign_blurb","tab_campaign_campaign_runtimedays","tab_campaign_campaign_totalbackers","tab_campaign_campaign_fundedamount","tab_campaign_campaign_fundedgoal","tab_campaign_campaign_fundedpercentage"]);return $scope.cfeature=value.tab_campaign_campaign_feature,$scope.cid_column=value.tab_campaign_campaign_id,$scope.cname=value.tab_campaign_campaign_name,$scope.ccreator=value.tab_campaign_campaign_creator,$scope.cend=value.tab_campaign_campaign_end,$scope.cstatus=value.tab_campaign_campaign_status,$scope.startdate=value.tab_campaign_start,$scope.csvHeaders={Feature:$scope.cfeature,Id:$scope.cid_column,Name:$scope.cname,Creator:$scope.ccreator,Blurb:value.tab_campaign_campaign_blurb,"Business Organization":value.tab_campaign_campaign_business,Category:value.tab_campaign_campaign_category,Location:"Location",Currency:value.tab_campaign_campaign_currency,File:value.tab_campaign_campaign_file,Start:$scope.startdate,End:$scope.cend,"Runtime Days":value.tab_campaign_campaign_runtimedays,"Total Backers":value.tab_campaign_campaign_totalbackers,"Funded Amount":value.tab_campaign_campaign_fundedamount,"Funded Goal":value.tab_campaign_campaign_fundedgoal,"Funded Percentage":value.tab_campaign_campaign_fundedpercentage,Status:$scope.cstatus},$scope.portal_settings.site_campaign_country_funding_step&&($scope.csvHeaders.bank=value.tab_campaign_bank),$scope.allCampaignsCompletecsv.push($scope.csvHeaders),angular.forEach($scope.allCampaignsArray,function(values){CampaignSettingsService.setCampaignId(values.entry_id),CampaignSettingsService.processSettings(values.settings),values.settings=CampaignSettingsService.getSettings();var business_organizations="",url_paths="",categories="",currencies="",path_external="",campaign_locations="";values.business_organizations&&(business_organizations=values.business_organizations[0].name),values.url_paths&&(url_paths=values.url_paths[0].path),values.categories&&(categories=values.categories[0].name),values.currencies&&(currencies=values.currencies[0].name),values.files&&(path_external=values.files[0].path_external),values.cities&&angular.forEach(values.cities,function(city){campaign_locations=campaign_locations+city.city_full+"; "});var data2={};switch(values.featured?$scope.featurestat=value.tab_campaign_featureYes:$scope.featurestat=value.tab_campaign_featureNo,values.entry_status_id){case 1:$scope.entrystat=value.BeingEdited;break;case 2:$scope.entrystat=value.ApprovedRunning;break;case 3:$scope.entrystat=value.NotApproved;break;case 4:$scope.entrystat=value.Paused;break;case 5:$scope.entrystat=value.ProcessingPreAuth;break;case 6:$scope.entrystat=value.AceptedForCapture;break;case 7:$scope.entrystat=value.DeclineForCapture;break;case 8:$scope.entrystat=value.ProcessingCapture;break;case 9:$scope.entrystat=value.CaptureComplete;break;case 10:$scope.entrystat=value.SentForReview;break;case 11:$scope.entrystat=value.Cancelled;break;case 12:$scope.entrystat=value.BeingReviewed;break;case 13:$scope.entrystat=value.NotFunded}$scope.creator=values.managers[0].first_name+" "+values.managers[0].last_name,values.starts?$scope.startdate=values.starts.slice(0,10):$scope.startdate="",values.ends?$scope.enddate=values.ends.slice(0,10):$scope.enddate="",data2={Feature:$scope.featurestat,Id:values.id,Name:values.name,Creator:$scope.creator,Blurb:values.blurb,"Business Organization":business_organizations,Category:categories,Location:campaign_locations,Currency:currencies,File:path_external,Start:$scope.startdate,End:$scope.enddate,"Runtime Days":values.runtime_days,"Total Backers":values.total_backers,"Funded Amount":values.funded_amount,"Funded Goal":values.funding_goal,"Funded Percentage":values.funded_percentage,Status:$scope.entrystat},$scope.portal_settings.site_campaign_country_funding_step&&(data2.bank=JSON.stringify(values.settings.bank)),$scope.allCampaignsCompletecsv.push(data2)}),$scope.allCampaignsCompletecsv})}function getSelectedItems(){var $table,selectedItems=[];return $table=$scope.isTransaction?$(".transaction-table"):$(".campaign-table"),$table.find("tbody > tr").each(function(index){$(this).find(".t-check-box input").prop("checked")&&($scope.isTransaction?selectedItems.push($scope.transaction_detail[index]):selectedItems.push($(this).scope().campaign))}),selectedItems}function setShippingVar(){$scope.alt_shipping=$scope.portal_settings.site_theme_alt_shipping_layout,$scope.native_lookup=$scope.portal_settings.site_theme_shipping_native_lookup,$scope.native_lookup&&($scope.portal_settings.site_theme_default_shipping_country.name=$scope.portal_settings.site_theme_default_shipping_country.native_name),$scope.default_country=$scope.portal_settings.site_theme_default_shipping_country,$scope.selectedCountry.selected=$scope.portal_settings.site_theme_default_shipping_country,$scope.setCountry($scope.selectedCountry.selected),null!=$scope.selectedCountry.selected&&Object.getOwnPropertyNames($scope.selectedCountry.selected).length&&getSubcountries($scope.selectedCountry.selected.id),$scope.alt_shipping&&getCountries()}function getCountries(){Geolocator.getCountries().then(function(countries){if($scope.native_lookup)for(var i in countries)null!=countries[i].native_name&&(countries[i].name=countries[i].native_name);if($scope.countries=countries,$scope.default_country){for(var index in $scope.countries){var value=$scope.countries[index];if(value.id==$scope.default_country.id){$scope.default_country=value,$scope.countries.splice(index,1);break}}$scope.countries.splice(0,0,$scope.default_country)}})}function getSubcountries(countryID){Geolocator.getSubcountriesByCountry(countryID).then(function(subcountries){if($scope.native_lookup)for(var i in subcountries)null!=subcountries[i].native_name&&(subcountries[i].name=subcountries[i].native_name);$scope.subcountries=subcountries})}function clearAddress(){$scope.selectedCity.selected=void 0,$scope.selectedSubcountry.selected=void 0,$scope.selectedCountry.selected=$scope.portal_settings.site_theme_default_shipping_country,$scope.shipOptions=[],$scope.user.postal_code="",$scope.user.street1="",$scope.user.street2=""}function deleteRevisionById(entry_id,entry_revision_id){return Restangular.one("campaign",entry_id).customDELETE("revision/"+entry_revision_id)}$scope.clearMessage=function(){$rootScope.floatingMessage=[]};var msg={};$scope.campaign_buffer=[],Restangular.one("campaign/status").customGET().then(function(success){$scope.campaignStatus=success}),$scope.isFeaturedCampaignsLoaded=!1,$scope.loadCampaignRevisions=function(){Restangular.one("portal/campaign-revision").customGET().then(function(success){$scope.campaignRevisions=success.plain()})},$scope.loadCampaignRevisions(),$scope.filename="transactiondatadetails",$scope.filename="campaign",$scope.campaigndata=[],$scope.transactiondata=[],$scope.details=!1,$scope.selectedCity={},$scope.ordertype="",$scope.orderbtn=!0,$scope.ordertypeid="-entry_id",$scope.orderbtnid=!0,$scope.ordertypeend="-ends",$scope.orderbtnend=!0,$scope.ordertypestatus="-entry_status",$scope.orderbtnstatus=!0,$scope.ordertypename="-name",$scope.namebtn=!0,$scope.nameshow=!1,$scope.idshow=!1,$scope.startshow=!1,$scope.endshow=!1,$scope.selectedCity={},$scope.selectedSubcountry={},$scope.selectedCountry={};var detailTransactionData={cindex:"",cname:"",cstatus:""};$scope.isTransaction=!1,$scope.sortOrFiltersCampaign={sort:$scope.ordertype+"-display_priority,-created",filters:{category:{},location:""},page_entries:10,page_limit:100,pagination:{},page:1},$scope.showManualTransactionFromCamp=!1,$scope.showManualTransactionFromTrans=!1,$scope.isAnonymous=[{type_id:"0",name:"tab_campaign_regular_contribution"},{type_id:"1",name:"tab_campaign_partially_anonymous_contribution"},{type_id:"2",name:"tab_campaign_fully_anonymous_contribution"}],$scope.user={first_name:"",last_name:"",phone:"",email:"",occupation:"",employer:"",address1:"",address2:"",city_id:"",country_id:"",reward:"",amount:"",cheque_ref:"",postal_code:"",anonymous:$scope.isAnonymous[0]},$scope.address={city_id:"",mail_code:"",street1:"",street2:"",country_id:""},$scope.fromPage="",$scope.selectedCampaign="";var globalPhoneNumberType={},globalStripeStatus=[],globalStripeType=[];$scope.isCampaignRevisionsView=!1,$scope.selectedRevisions=[],$scope.tip={value:null,type:"Dollar"},PortalSettingsService.getSettingsObj().then(function(success){$scope.portal_settings=success.public_setting,$scope.isISODate=success.public_setting.site_theme_campaign_display_iso_date,$scope.enableCampaignRevisions=success.public_setting.site_campaign_enable_campaign_revisions,$scope.isFeaturedCampaignLimitIncreased=success.public_setting.site_increase_featured_campaigns_limit,$scope.tippingOptions=success.public_setting.site_tipping,$scope.tippingOptions&&$scope.tippingOptions.toggle?!$scope.tippingOptions.toggle_dynamic&&$scope.tippingOptions.toggle_tiers&&$scope.tippingOptions.tiers&&($scope.tip={value:$scope.tippingOptions.tiers[0].value,type:$scope.tippingOptions.tiers[0].type}):$scope.tippingOptions={},$scope.isFeaturedCampaignLimitIncreased?$scope.featuredCampaignsLimit=100:$scope.featuredCampaignsLimit=4,setShippingVar(),$scope.portal_settings.site_campaign_always_anonymous_contribution&&($scope.isAnonymous=$scope.isAnonymous.slice($scope.isAnonymous.length-1))}),$translate(["Landline Phone Number","Mobile Phone Number","Fax Phone Number"]).then(function(phoneNumberType){globalPhoneNumberType=phoneNumberType}),$translate(["stripe_status_status_new_ready_process","stripe_status_status_new_being_processed","stripe_status_status_processed_success","stripe_status_status_processed_failure","stripe_status_type_pledge_preauth","stripe_status_type_pledge_capture"]).then(function(stripeTranslation){for(var stripeResp in stripeTranslation)stripeTranslation.hasOwnProperty(stripeResp)&&(globalStripeStatus.length<4?globalStripeStatus.push(stripeTranslation[stripeResp]):globalStripeType.push(stripeTranslation[stripeResp]))}),$scope.setEnabled=function(){var campaignClassDisabled=".campaign"+$scope.selectedCampaign+" .transaction_button";jQuery(campaignClassDisabled).removeClass("disabled")};var hideMsg=function(){$timeout(function(){$scope.msgHide=!0,$scope.msgHide=!1},1e4)};$(".order-by-priority").checkbox("check"),$scope.sortByPriority=function(){$scope.nameshow=!1,$scope.idshow=!1,$scope.startshow=!1,$scope.endshow=!1,$(".order-by-priority").checkbox("is checked")||($scope.sortOrFiltersCampaign.sort="-display_priority,-created,-entry_id,-ends",updateCampaignListing($scope.sortOrFiltersCampaign))},$scope.changeOrderStart=function(){$(".order-by-priority").checkbox("uncheck"),$scope.idshow=!1,$scope.startshow=!0,$scope.endshow=!1,$scope.nameshow=!1,"-created"==$scope.ordertype?($scope.ordertype="created",$scope.orderbtn=!1,$scope.sortOrFiltersCampaign.sort="created,display_priority,entry_id,ends"):($scope.orderbtn=!0,$scope.ordertype="-created",$scope.sortOrFiltersCampaign.sort="-created,-display_priority,-entry_id,-ends"),$scope.sortOrFiltersCampaign.page_entries=$("#resultValue").text(),updateCampaignListing($scope.sortOrFiltersCampaign)},$scope.changeOrderName=function(){$(".order-by-priority").checkbox("uncheck"),$scope.idshow=!1,$scope.startshow=!1,$scope.endshow=!1,$scope.nameshow=!0,"-name"==$scope.ordertypename?($scope.ordertypename="name",$scope.namebtn=!1,$scope.sortOrFiltersCampaign.sort="name,created,display_priority,entry_id,ends"):($scope.namebtn=!0,$scope.ordertypename="-name",$scope.sortOrFiltersCampaign.sort="-name,-display_priority,-entry_id,-ends"),$scope.sortOrFiltersCampaign.page_entries=$("#resultValue").text(),updateCampaignListing($scope.sortOrFiltersCampaign)},$scope.manualOrder=!1,$scope.clearReward=function(){$(".reward.dropdown").dropdown("clear"),$scope.selectedReward=null,$scope.shipAdd=!1,$scope.user.amount=null},$scope.addManual=function(cid,cname,cstatus){initializeUserObj(),clearAddress(),$scope.clearReward(),$scope.user.amount=null,$scope.manualOrder=!0,$scope.transaction_message=!1,null!=cid?($scope.cid=cid,$scope.showManualTransactionFromCamp=!0):$scope.showManualTransactionFromTrans=!0,null!=cstatus&&($scope.cEntryStatus=cstatus),CreateCampaignService.load($scope.cid).then(function(success){$scope.campaignSelected=success,$scope.ccurrency=success.currencies,null!=success.pledges?$scope.campaignRewards=success.pledges:$scope.campaignRewards=null})},$scope.verifyReward=function(selectedReward){$scope.selectedReward=selectedReward,selectedReward.shipping?$scope.shipAdd=!0:$scope.shipAdd=!1},$scope.setAnonymous=function(anonymous){$scope.user.anonymous=anonymous},$scope.tipTypeSelection=function(type){$scope.tip={value:null,type:"Dollar"},"tiers"==type?$scope.tippingOptions.tiers&&($scope.tip={value:$scope.tippingOptions.tiers[0].value,type:$scope.tippingOptions.tiers[0].type}):"dynamic"==type&&$scope.tippingOptions.toggle_dynamic_min_max&&$scope.tippingOptions.dynamic_min&&($scope.tip.value=$scope.tippingOptions.dynamic_min),$scope.selectedTipType=type},$scope.tipTierSelection=function(value,type){$scope.tip={value:parseInt(value),type:type}},$scope.transaction_message=!1,$scope.addTransaction=function(){var not_validated=$("form.manual-trans-form").find(".ng-invalid,.has-error");if(not_validated.length>0)return void($scope.formError=!0);$scope.formError=!1,$scope.transaction_error=!1,$scope.errorMessae="";for(var length=15,charset="abcdefghijklnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",retVal="",n=charset.length,i=0;i<length;i++)retVal+=charset.charAt(Math.floor(Math.random()*n));var userdata={first_name:$scope.user.first_name,last_name:$scope.user.last_name,email:$scope.user.email,password:retVal,password_confirm:retVal,inline_registration:!0};$scope.pdata={entry_id:$scope.campaignSelected.entry_id,pledge_level_id:"",amount:$scope.user.amount,person_id:"",anonymous_contribution:"",anonymous_contribution_partial:"",shipping_address_id:"",phone_number_id:"",use_widgetmakr:"",email_notify:$scope.email_notify,reference_no:$scope.user.cheque_ref},$scope.pdata.email_notify=$(".ui.checkbox.notifyEmail input").prop("checked"),1==$scope.user.anonymous.type_id?($scope.pdata.anonymous_contribution_partial=1,$scope.pdata.anonymous_contribution=0):2==$scope.user.anonymous.type_id?($scope.pdata.anonymous_contribution_partial=0,$scope.pdata.anonymous_contribution=1):($scope.pdata.anonymous_contribution_partial=0,$scope.pdata.anonymous_contribution=0),$scope.portal_settings.site_campaign_always_anonymous_contribution&&($scope.pdata.anonymous_contribution_partial=0,$scope.pdata.anonymous_contribution=1),$scope.tippingOptions&&$scope.tippingOptions.toggle&&$scope.tip.value&&0!=$scope.tip.value&&("Dollar"==$scope.tip.type?$scope.pdata.amount_tip=parseFloat($scope.tip.value):$scope.pdata.amount_tip=parseFloat($scope.tip.value)/100*$scope.user.amount),Restangular.one("portal/setting").getList().then(function(success){$scope.public_set={},angular.forEach(success,function(value){3==value.setting_type_id&&($scope.public_set[value.name]=value.value,2==$scope.public_set.site_payment_gateway&&($scope.pdata.use_widgetmakr=1))})}),Restangular.one("account/email").customGET(userdata.email).then(function(success){$scope.personId=success.person_id,$scope.pdata.person_id=$scope.personId,$scope.TransactionAdd($scope.personId)},function(failed){Restangular.one("register").customPOST(userdata).then(function(success){$scope.registering_user=success,$scope.pdata.person_id=success.person_id,$scope.TransactionAdd($scope.personId)},function(failed){})})},$scope.TransactionAdd=function(personID){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var phoneReqResult,addressReqResult,prePromisesArray=[],prePhoneReq=Restangular.one("account").customGET("phone-number",{person_id:personID});prePhoneReq.then(function(success){phoneReqResult=success});var preAddressReq=Restangular.one("account").customGET("address",{person_id:personID});preAddressReq.then(function(success){addressReqResult=success}),prePromisesArray=[prePhoneReq,preAddressReq],$q.all(prePromisesArray).then(function(success){var promisesArray=[];if($scope.phoneInfo={number:$scope.user.phone,person_id:$scope.pdata.person_id},$scope.user.phone){var phoneReq;null==phoneReqResult.personal?phoneReq=Restangular.one("account/phone-number").customPOST({number:$scope.user.phone,phone_number_type_id:2}):phoneReqResult.personal[0]&&(phoneReq=Restangular.one("account/phone-number",phoneReqResult.personal[0].id).customPUT({person_id:personID,number:$scope.user.phone})),phoneReq.then(function(success){$scope.pdata.phone_number_id=success.phone_number_id},function(failed){$scope.pdata.phone_number_id=""}),promisesArray.push(phoneReq)}if(null!=$scope.selectedReward&&($scope.pdata.pledge_level_id=$scope.selectedReward.pledge_level_id,null!=$scope.selectedReward.shipping))if($scope.user.address1){var addressReq,shipdetails={city_id:$scope.user.city_id,street1:$scope.user.address1,street2:$scope.user.address2,mail_code:$scope.user.postal_code,person_id:$scope.pdata.person_id};addressReqResult.personal&&addressReqResult.personal.length?(shipdetails.shipping_address_id=addressReqResult.personal[0].id,addressReq=Restangular.one("account/address",addressReqResult.personal[0].id).customPUT(shipdetails)):addressReq=Restangular.one("account/address").customPOST(shipdetails),addressReq.then(function(success){$scope.pdata.shipping_address_id=success.address_id},function(failed){$scope.pdata.shipping_address_id=""}),promisesArray.push(addressReq)}else $scope.transaction_error=!0,$scope.eMessage="tab_campaigns_shipping_address_required";$q.all(promisesArray).then(function(success){Restangular.one("campaign/"+$scope.campaignSelected.entry_id+"/pledge/manual").customPOST($scope.pdata).then(function(success){msg={header:"tab_campaigns_manual_transaction_added"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.manualOrder=!1,$scope.user="",hideMsg(),$scope.showdetail($scope.cid,$scope.cname,$scope.cEntryStatus,$scope.ccurrency,$scope.total_backers,$scope.backer_offset),$scope.setEnabled(),$scope.showManualTransactionFromCamp=!1,$scope.showManualTransactionFromTrans=!1},function(failed){$scope.eMessage=failed.data.message})})})},$scope.changeOrderId=function(){$(".order-by-priority").checkbox("uncheck"),$scope.idshow=!0,$scope.startshow=!1,$scope.endshow=!1,$scope.nameshow=!1,"-entry_id"==$scope.ordertypeid?($scope.ordertypeid="entry_id",$scope.orderbtnid=!1,$scope.sortOrFiltersCampaign.sort="entry_id,display_priority,created,ends"):($scope.orderbtnid=!0,$scope.ordertypeid="-entry_id",$scope.sortOrFiltersCampaign.sort="-entry_id,-display_priority,-created,-ends"),$scope.sortOrFiltersCampaign.page_entries=$("#resultValue").text(),updateCampaignListing($scope.sortOrFiltersCampaign)},$scope.changeOrderEnd=function(){$(".order-by-priority").checkbox("uncheck"),$scope.idshow=!1,$scope.startshow=!1,$scope.endshow=!0,$scope.nameshow=!1,"-ends"==$scope.ordertypeend?($scope.ordertypeend="ends",$scope.orderbtnend=!1,$scope.sortOrFiltersCampaign.sort="ends,display_priority,created,entry_id"):($scope.orderbtnend=!0,$scope.ordertypeend="-ends",$scope.sortOrFiltersCampaign.sort="-ends,-display_priority,-created,-entry_id"),$scope.sortOrFiltersCampaign.page_entries=$("#resultValue").text(),updateCampaignListing($scope.sortOrFiltersCampaign)},updateCampaignListing($scope.sortOrFiltersCampaign),$scope.updateCampaignListing=function(){updateCampaignListing($scope.sortOrFiltersCampaign)},$scope.updateSortCampaign=function(sort){$scope.sortOrFiltersCampaign.sort=sort?sort:"",updateCampaignListing($scope.sortOrFiltersCampaign)},$scope.updateFiltersCampaignCategory=function(category){$scope.sortOrFiltersCampaign.filters.category=category.id,updateCampaignListing($scope.sortOrFiltersCampaign)},$scope.updateFiltersCampaignStatus=function(status){status?$scope.sortOrFiltersCampaign.filters.entry_status_id=status.id:$scope.sortOrFiltersCampaign.filters.entry_status_id="",updateCampaignListing($scope.sortOrFiltersCampaign)},$scope.updateFiltersCampaignType=function(type){1==type?$scope.sortOrFiltersCampaign.filters.hidden=!0:$scope.sortOrFiltersCampaign.filters.hidden=!1,updateCampaignListing($scope.sortOrFiltersCampaign)},$scope.createCampaignCSV=createCampaignCSV,$scope.createCampaignCompleteCSV=createCampaignCompleteCSV,$scope.data=[],$scope.showdetail=function(index,cname,cstatus,ccurrency,total_backers,backer_offset){$scope.cindex=index,$scope.cname=cname,$scope.cstatus=cstatus,$scope.ccurrency=ccurrency,detailTransactionData.cindex=index,detailTransactionData.cname=cname,detailTransactionData.cstatus=cstatus,$scope.data=[],$scope.isTransaction=!0,$scope.transactiondata=[],$scope.details=!0,$scope.campaign_name=cname,$scope.cid=index,$scope.currency=ccurrency,$scope.total_backers=total_backers,$scope.backer_offset=backer_offset,$scope.transaction_pagination={sort:"-created",page_entries:100,page_limit:100,page:1,pagination:{},summary:0},"Approved / Running"==cstatus&&($scope.approvedCamp="true"),Restangular.one("portal/setting").getList().then(function(success){$scope.public_settings={},angular.forEach(success,function(value){3==value.setting_type_id&&($scope.public_settings[value.name]=value.value,$scope.payment_gateway=$scope.public_settings.site_payment_gateway)}),1==$scope.payment_gateway?(Restangular.one("campaign/"+index+"/stats").customGET(null,{summary:1}).then(function(success){$scope.transaction_summary=success}),$scope.getTransactions(index)):Restangular.one("campaign/"+index+"/stats").customGET(null,{summary:1,use_widgetmakr:1}).then(function(success){$scope.transaction_summary=success,$scope.getTransactions(index)})},function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})},$scope.setSelectedCampaign=function(selectedC){$scope.selectedCampaign=selectedC},$scope.transaction_pagination={sort:"-created",page_entries:100,page_limit:100,page:1,pagination:{},summary:0},$scope.getTransactions=function(index){RestFullResponse.all("campaign/"+index+"/stats").getList($scope.transaction_pagination).then(function(success){$scope.transaction_detail=success.data,$scope.na="";var headers=success.headers();headers["x-pager-total-entries"]?$scope.transaction_length=headers["x-pager-total-entries"]:$scope.transaction_length="0",$scope.transaction_pagination.currentpage=headers["x-pager-current-page"],$scope.transaction_pagination.numpages=headers["x-pager-last-page"],$scope.transaction_pagination.nextpage=headers["x-pager-next-page"],$scope.transaction_pagination.pagesinset=headers["x-pager-pages-in-set"],$scope.transaction_pagination.totalentries=headers["x-pager-total-entries"],$scope.transaction_pagination.entriesperpage=headers["x-pager-entries-per-page"]})},$scope.createTransactionCSV=function(campaign_id){var transactionRequestArray=[],totalNumTransaction=$scope.transaction_pagination.totalentries,requiredNumCalls=0;$scope.allTransactionArray=[];requiredNumCalls=parseInt(parseInt(totalNumTransaction)/100),totalNumTransaction%100!=0&&(requiredNumCalls+=1),
$scope.transaction_pagination_csv={sort:"-created",page_entries:100,page_limit:150,page:1,pagination:{},summary:0};for(var curNumCall=0;curNumCall<requiredNumCalls;curNumCall++){var request=RestFullResponse.all("campaign/"+campaign_id+"/stats").getList($scope.transaction_pagination_csv);transactionRequestArray.push(request),$scope.transaction_pagination_csv.page+=1}return $q.all(transactionRequestArray).then(function(success){$scope.allTransactioncsv=[],success.forEach(function(resArr){$scope.allTransactionArray=$scope.allTransactionArray.concat(resArr.data)});var nativeLookup=$scope.public_settings.site_theme_shipping_native_lookup,value=$translate.instant(["transaction_details_withdrawn","transaction_details_card_number","transaction_details_Manual_Transaction","transaction_details_na","transaction_details_transaction_id","transaction_details_contributors_first","transaction_details_contributors_last","transaction_details_reward","transaction_details_amount","transaction_details_status","transaction_details_date","transaction_details_contributors_email","transaction_details_shipping_address","transaction_details_phone_number","transaction_details_reward_attribute","transaction_details_charity_UK_taxpayer","transaction_details_charity_giftaid","transaction_details_charity_fullname","transaction_details_charity_fulladdress","transaction_details_charity_postcode","transaction_details_charity_amount","transaction_details_organization_name","transaction_details_organization_email","transaction_details_organization_phone","transaction_details_organization_address"]);return $scope.cardnum=value.transaction_details_card_number,$scope.noreward=value.transaction_details_na,$scope.tid=value.transaction_details_transaction_id,$scope.treward=value.transaction_details_reward,$scope.tamount=value.transaction_details_amount,$scope.tstatus=value.transaction_details_status,$scope.tnamef=value.transaction_details_contributors_first,$scope.tnamel=value.transaction_details_contributors_last,$scope.temail=value.transaction_details_contributors_email,$scope.tdate=value.transaction_details_date,$scope.taddress=value.transaction_details_shipping_address,$scope.tphone=value.transaction_details_phone_number,$scope.twithdraw=value.transaction_details_withdrawn,$scope.manual=value.transaction_details_Manual_Transaction,$scope.attributes=value.transaction_details_reward_attribute,$scope.tbusiness_organization=value.transaction_details_organization_name,$scope.tbusiness_organization_email=value.transaction_details_organization_email,$scope.tbusiness_organization_phone=value.transaction_details_organization_phone,$scope.tbusiness_organization_address=value.transaction_details_organization_address,$scope.csvHeaders={ID:$scope.tid,Reward:$scope.treward,Amount:$scope.tamount,Status:$scope.tstatus,"First Name":$scope.tnamef,"Last Name":$scope.tnamel,Email:$scope.temail,Card:$scope.cardnum,Date:$scope.tdate,Address:$scope.taddress,Phone:$scope.tphone,Attributes:$scope.attributes,"Organization Name":$scope.tbusiness_organization,"Organization Email":$scope.tbusiness_organization_email,"Organization Phone":$scope.tbusiness_organization_phone,"Organization Address":$scope.tbusiness_organization_address},$scope.tippingOptions.toggle&&($scope.csvHeaders.Tip=value.transaction_details_tip),$scope.public_settings.site_campaign_charity_helper_enable&&($scope.csvHeaders["UK Tax Payer"]=value.transaction_details_charity_UK_taxpayer,$scope.csvHeaders["Gift Aid"]=value.transaction_details_charity_giftaid,$scope.csvHeaders["Full name"]=value.transaction_details_charity_fullname,$scope.csvHeaders["Full Address"]=value.transaction_details_charity_fulladdress,$scope.csvHeaders.Postcode=value.transaction_details_charity_postcode,$scope.csvHeaders["Gift Amount"]=value.transaction_details_charity_amount),$scope.allTransactioncsv.push($scope.csvHeaders),angular.forEach($scope.allTransactionArray,function(value){var data1={},organization_name="",organization_email="";if($scope.businessDataPhoneNumber="",$scope.busCompleteaddress="",value.card?($scope.cardn="**** **** ****"+value.card[0].last4,$scope.tstatus=globalStripeStatus[value.stripe_transaction_status_id-1]):($scope.cardn=value.reference_no,$scope.tstatus=$scope.manual),value.backer){if(value.backer[0].disabled&&($scope.tstatus=$scope.twithdraw),value.backer[0].business_organization&&value.backer[0].business_organization[0]){organization_name=value.backer[0].business_organization[0].name,organization_email=value.backer[0].business_organization[0].email;var businessPhoneType,businessPhoneNumberObj=value.backer[0].business_organization[0].business_organization_shipping_phone_number;null!=businessPhoneNumberObj&&(businessPhoneType=globalPhoneNumberType[businessPhoneNumberObj[0].phone_number_type]),$scope.businessDataPhoneNumber=null!=businessPhoneNumberObj?businessPhoneNumberObj[0].number+" "+businessPhoneType:"",$scope.busShipadd=value.backer[0].business_organization[0].business_organization_shipping_address[0],nativeLookup?($scope.busShipadd.city=null!=$scope.busShipadd.city_native_name?$scope.busShipadd.city_native_name:$scope.busShipadd.city,$scope.busShipadd.subcountry=null!=$scope.busShipadd.subcountry_native_name?$scope.busShipadd.subcountry_native_name:$scope.busShipadd.subcountry,$scope.busShipadd.country=null!=$scope.busShipadd.country_native_name?$scope.busShipadd.country_native_name:$scope.busShipadd.country,$scope.busCompleteaddress=$scope.busShipadd.country+", "+$scope.busShipadd.mail_code+", "+$scope.shipadd.subcountry+", "+$scope.busShipadd.city+", "+$scope.busShipadd.street1):$scope.busCompleteaddress=$scope.busShipadd.street1+" , "+$scope.busShipadd.city+" "+$scope.busShipadd.subcountry+" "+$scope.busShipadd.mail_code+" , "+$scope.busShipadd.country}if(value.backer[0].person){$scope.addbacker=value.backer[0].person[0],value.backer[0].pledge_level?$scope.rewardname=value.backer[0].pledge_level[0].name:$scope.rewardname=$scope.noreward;var phoneType,phoneNumberObj=value.backer[0].person[0].person_shipping_phone_number;null!=phoneNumberObj&&(phoneType=globalPhoneNumberType[phoneNumberObj[0].phone_number_type]),$scope.dataPhoneNumber=null!=phoneNumberObj?phoneNumberObj[0].number+" "+phoneType:"";var parsedEmail=$scope.addbacker.email.split("|||")[0];$scope.addbacker.person_shipping_address?($scope.shipadd=$scope.addbacker.person_shipping_address[0],nativeLookup?($scope.shipadd.city=null!=$scope.shipadd.city_native_name?$scope.shipadd.city_native_name:$scope.shipadd.city,$scope.shipadd.subcountry=null!=$scope.shipadd.subcountry_native_name?$scope.shipadd.subcountry_native_name:$scope.shipadd.subcountry,$scope.shipadd.country=null!=$scope.shipadd.country_native_name?$scope.shipadd.country_native_name:$scope.shipadd.country,$scope.completeaddress=$scope.shipadd.country+", "+$scope.shipadd.mail_code+", "+$scope.shipadd.subcountry+", "+$scope.shipadd.city+", "+$scope.shipadd.street1):$scope.completeaddress=$scope.shipadd.street1+" , "+$scope.shipadd.city+" "+$scope.shipadd.subcountry+" "+$scope.shipadd.mail_code+" , "+$scope.shipadd.country,data1={ID:value.stripe_transaction_id,Reward:$scope.rewardname,Amount:value.backer[0].amount,Status:$scope.tstatus,"First Name":$scope.addbacker.first_name,"Last Name":$scope.addbacker.last_name,Email:parsedEmail,Card:$scope.cardn,Date:value.created.slice(0,19),Address:$scope.completeaddress,Phone:$scope.dataPhoneNumber,Attributes:JSON.stringify(value.backer[0].attributes),"Organization Name":organization_name,"Organization Email":organization_email,"Organization Phone":$scope.businessDataPhoneNumber,"Organization Address":$scope.busCompleteaddress}):data1={ID:value.stripe_transaction_id,Reward:$scope.rewardname,Amount:value.backer[0].amount,Status:$scope.tstatus,"First Name":$scope.addbacker.first_name,"Last Name":$scope.addbacker.last_name,Email:parsedEmail,Card:$scope.cardn,Date:value.created.slice(0,19),Address:$scope.na,Phone:$scope.dataPhoneNumber,Attributes:JSON.stringify(value.backer[0].attributes),"Organization Name":organization_name,"Organization Email":organization_email,"Organization Phone":$scope.businessDataPhoneNumber,"Organization Address":$scope.busCompleteaddress},$scope.tippingOptions.toggle&&(value.backer[0].amount_tip&&0!=value.backer[0].amount_tip?data1.Tip=value.backer[0].amount_tip:data1.Tip=0),$scope.public_settings.site_campaign_charity_helper_enable&&value.backer[0].attributes&&value.backer[0].attributes.charity&&(data1["UK Tax Payer"]=value.backer[0].attributes.charity.is_a_tax_payer,data1["Gift Aid"]=value.backer[0].attributes.charity.is_a_gift,data1["Full name"]=value.backer[0].attributes.charity.fullname,data1["Full Address"]=value.backer[0].attributes.charity.address,data1.Postcode=value.backer[0].attributes.charity.postcode,data1["Gift Amount"]=value.backer[0].charity_helper_amount),$scope.allTransactioncsv.push(data1)}}}),$scope.allTransactioncsv})},$scope.goBackUser=function(){$scope.showManualTransactionFromTrans||($scope.details=!1,$scope.user="",$scope.transaction_message=!1,$scope.manualOrder=!1,$scope.transaction_error=!1,$scope.approvedCamp=!1,$scope.isTransaction=!1,$scope.showManualTransactionFromCamp=!1),$scope.showManualTransactionFromTrans=!1},$scope.showManualTransactionFromTrans=!1,$scope.backCampaign=function(){},$scope.showContact=function(index){var nativeLookup=$scope.public_settings.site_theme_shipping_native_lookup;if($scope.shippingPhoneNumber=null,$scope.shippingAdress=null,null!=$scope.transaction_detail[index].backer[0].person[0].person_shipping_phone_number){var phoneNumber=$scope.transaction_detail[index].backer[0].person[0].person_shipping_phone_number[0].number,phoneType=$scope.transaction_detail[index].backer[0].person[0].person_shipping_phone_number[0].phone_number_type;$scope.shippingPhoneNumber=phoneNumber,$translate(phoneType).then(function(translation){$scope.shippingPhoneType=translation})}if(null!=$scope.transaction_detail[index].backer[0].person[0].person_shipping_address)if($scope.address=$scope.transaction_detail[index].backer[0].person[0].person_shipping_address,$scope.shippingAdress=$scope.address,$scope.alt_shipping){if($scope.alt_shipping){var name=$scope.transaction_detail[index].backer[0].person[0].first_name+" "+$scope.transaction_detail[index].backer[0].person[0].last_name,city=null!=$scope.address[0].city_native_name&&nativeLookup?$scope.address[0].city_native_name:$scope.address[0].city,country=null!=$scope.address[0].country_native_name&&nativeLookup?$scope.address[0].country_native_name:$scope.address[0].country,street=$scope.address[0].street1,mailcode=$scope.address[0].mail_code,subcountry=null!=$scope.address[0].subcountry_native_name&&nativeLookup?$scope.address[0].subcountry_native_name:$scope.address[0].subcountry,address=subcountry+", "+city;if($scope.address[0].city_alt&&$scope.public_settings.site_campaign_alt_city_input_toggle)var address=subcountry+", "+$scope.address[0].city_alt;$("#backername").text(name),$("#street").text(street),$("#main_address").text(address),$("#country_name").text(country),$("#postcode").text(mailcode)}}else{var name=$scope.transaction_detail[index].backer[0].person[0].first_name+" "+$scope.transaction_detail[index].backer[0].person[0].last_name,city=null!=$scope.address[0].city_native_name&&nativeLookup?$scope.address[0].city_native_name:$scope.address[0].city,country=null!=$scope.address[0].country_native_name&&nativeLookup?$scope.address[0].country_native_name:$scope.address[0].country,street=$scope.address[0].street1,mailcode=$scope.address[0].mail_code,subcountry=null!=$scope.address[0].subcountry_native_name&&nativeLookup?$scope.address[0].subcountry_native_name:$scope.address[0].subcountry,address=city+", "+subcountry+" "+mailcode;if($scope.address[0].city_alt&&$scope.public_settings.site_campaign_alt_city_input_toggle)var address=$scope.address[0].city_alt+", "+subcountry+" "+mailcode;$("#backername").text(name),$("#street").text(street),$("#main_address").text(address),$("#country_name").text(country)}$(".small.test.modal").modal("show")},$scope.changeCampaignsStatus=function(statusID){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var campaignQueue=getSelectedItems(),requestQueue=[];0===campaignQueue.length?(msg={header:"tab_campaigns_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()):(angular.forEach(campaignQueue,function(campaign){var data={entry_status_id:statusID};requestQueue.push(Restangular.one("campaign",campaign.id).customPUT(data).then(function(success){campaign=success,$scope.syncCampaignandFeatured(campaign.id,"entry_status_id",statusID)}))}),$q.all(requestQueue).then(function(){msg={header:"tab_campaigns_campaign_status_set"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()},function(failed){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.progressStatusEnabled=function(){return $scope.portal_settings.site_campaign_state_hide&&$scope.portal_settings.site_campaign_state_settings.length>=1},$scope.changeMultipleCampaignsStatus=function(){0===getSelectedItems().length?(msg={header:"tab_campaigns_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()):$(".change-status-modal").modal({onApprove:function(){angular.forEach($scope.progressQueue,function(campaign){Restangular.one("campaign",campaign.id).one("setting").customPUT(campaign.data).then(function(success){})})}}).modal("show")},$scope.stateSelected=function(data){var campaignQueue=getSelectedItems();angular.forEach(campaignQueue,function(campaign){var campaignId=campaign.entry_id;$scope.progressQueue=[],CampaignSettingsService.retreiveSettings(campaignId).then(function(success){$scope.data={},angular.forEach(success,function(value){$scope.data[value.name]=value.value}),$scope.data.state_current=$scope.portal_settings.site_campaign_state_settings[data];var setting={};setting.id=campaignId,setting.data=$scope.data,$scope.progressQueue.push(setting)})})},$scope.featureCampaigns=function(feature){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var campaignQueue=getSelectedItems(),requestQueue=[];0===campaignQueue.length?(msg={header:"tab_campaigns_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()):(angular.forEach(campaignQueue,function(campaign){var data={featured:feature};requestQueue.push(Restangular.one("campaign",campaign.id).customPUT(data).then(function(success){campaign.featured=feature,$scope.syncCampaignandFeatured(campaign.id,"featured",feature)}))}),$q.all(requestQueue).then(function(){msg={header:"tab_campaigns_campaign_featured_set"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.getFeaturedCampaigns()},function(failed){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.hideCampaigns=function(hide){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var campaignQueue=getSelectedItems(),requestQueue=[];0===campaignQueue.length?(msg={header:"tab_campaigns_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()):(angular.forEach(campaignQueue,function(campaign){var data={hidden:hide};requestQueue.push(Restangular.one("campaign",campaign.id).customPUT(data).then(function(success){campaign.hidden=hide,$scope.syncCampaignandFeatured(campaign.id,"hidden",hide)}))}),$q.all(requestQueue).then(function(){msg={header:"tab_campaigns_campaign_visibility_set"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()},function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.getTotalItemsCampaign=function(){var desiredtotal=$scope.sortOrFiltersCampaign.pagination.entriesperpage*$scope.sortOrFiltersCampaign.page_limit;return desiredtotal>$scope.sortOrFiltersCampaign.pagination.totalentries?$scope.sortOrFiltersCampaign.pagination.totalentries:desiredtotal},$scope.editCampaign=function($event,campaign){$scope.campaign=campaign,window.open("getstarted/"+campaign.entry_id)},$scope.searchCampaignCities=function(term){var cityID=null;Geolocator.searchCities(term).then(function(cities){$scope.cities=cities,cityID=Geolocator.lookupCityID($scope.campaign.city),cityID?$scope.campaign.city_id=ctyID:$scope.campaign.city_id=""})},$scope.cities=[],$scope.searchCities=function(term){var native_lookup=1==$scope.native_lookup?1:0;term&&($scope.alt_shipping?Geolocator.searchCitiesBySubcountry(term,$scope.selectedSubcountry.selected.id,native_lookup).then(function(cities){if(native_lookup)for(var i in cities)null!=cities[i].city_native_name&&(cities[i].name=cities[i].city_native_name),null!=cities[i].country_native_name&&(cities[i].country=cities[i].country_native_name),null!=cities[i].subcountry_native_name&&(cities[i].subcountry=cities[i].subcountry_native_name);$scope.cities=cities}):Geolocator.searchCities(term,native_lookup).then(function(cities){$scope.cities=cities}))},$scope.getFeaturedCampaigns=function(){Restangular.all("campaign").getList({sort:"-display_priority",filters:{featured:"t"},page_entries:$scope.featuredCampaignsLimit}).then(function(success){$scope.isFeaturedCampaignsLoaded=!0,$scope.campaign_buffer=success,angular.forEach($scope.campaign_buffer,function(campaign){CampaignSettingsService.processSettings(campaign.settings),campaign.settings=CampaignSettingsService.getSettings()})})},$scope.setFeatured=function(campaign,feature){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var id=campaign.entry_id,data={featured:feature};feature||(data.display_priority=0),Restangular.one("campaign",id).customPUT(data).then(function(success){campaign.featured=feature,$scope.syncCampaignandFeatured(id,"featured",feature),$scope.getFeaturedCampaigns(),msg={header:"tab_campaigns_campaign_featured_set"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()},function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})},$scope.syncCampaignandFeatured=function(entry_id,key,value){for(var j=0;j<$scope.campaigns.length;j++)if($scope.campaigns[j].entry_id&&$scope.campaigns[j].entry_id==entry_id){$scope.campaigns[j][key]=value;break}for(var j=0;j<$scope.campaign_buffer.length;j++)if($scope.campaign_buffer[j].entry_id&&$scope.campaign_buffer[j].entry_id==entry_id){$scope.campaign_buffer[j][key]=value;break}},$scope.searchCampaignBy=function(search_value){$scope.sortOrFiltersCampaign.filters.name="",$scope.sortOrFiltersCampaign.filters.manager="",$scope.sortOrFiltersCampaign.filters[$scope.searchTypeChosen]=search_value,updateCampaignListing($scope.sortOrFiltersCampaign)},$scope.searchTypeChosen="name",$scope.searchType=function(search_type){$("#searchname").val(""),$scope.searchTypeChosen=search_type},$scope.deleteItems=function(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var itemQueue=getSelectedItems(),requestQueue=[];0===itemQueue.length?(msg={header:"tab_campaigns_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()):$(".delete-multi-items-modal").modal("setting",{onApprove:function(){angular.forEach(itemQueue,function(item){angular.forEach($scope.campaignRevisions,function(revision){item.entry_id==revision.entry_id&&requestQueue.push(deleteRevisionById(revision.entry_id,revision.entry_revision_id))}),$scope.isTransaction?requestQueue.push(Restangular.one("campaign",$scope.cid).one("pledge",item.backer[0].entry_backer_id).customDELETE()):requestQueue.push(Restangular.one("campaign",item.id).customDELETE())}),$q.all(requestQueue).then(function(){$scope.loadCampaignRevisions(),$scope.isTransaction?(msg=1==requestQueue.length?{header:"tab_campaign_transaction_has_benn_deleted_single"}:{header:"tab_campaign_transaction_has_benn_deleted_plural"},$scope.showdetail(detailTransactionData.cindex,detailTransactionData.cname,detailTransactionData.cstatus)):(msg={header:"tab_campaign_selected_deleted_success"},updateCampaignListing($scope.sortOrFiltersCampaign),$scope.getFeaturedCampaigns()),$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()},function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})}}).modal("show")},$scope.reviewCampaign=function(campaign,e){var data={entry_status_id:12};Restangular.one("campaign",campaign.entry_id.toString()).customPUT(data).then(function(success){for(var i=0;i<$scope.campaigns.length;i++)if($scope.campaigns[i].entry_id==success.entry_id){$scope.campaigns[i]=success;break}},function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),window.open("/campaign-review/"+campaign.entry_id)},$scope.updateCampaignStatus=function(campaign,status){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,campaign.entry_status_id=status.entry_status_id,campaign.entry_status=status.name,campaign_status={entry_status_id:campaign.entry_status_id},Restangular.one("campaign/"+campaign.entry_id.toString()).customPUT(campaign_status).then(function(success){$translate(["Campaign","updated"]).then(function(value){$scope.c=value.Campaign,$scope.update=value.updated,msg={header:$scope.c+" "+campaign.name+" "+$scope.update},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage(),$scope.syncCampaignandFeatured(campaign.entry_id,"entry_status_id",status.entry_status_id)})},function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})},Date.prototype.yyyymmdd=function(){var yyyy=this.getFullYear().toString(),mm=(this.getMonth()+1).toString(),dd=this.getDate().toString(),h=this.getHours().toString(),m=this.getMinutes().toString(),s=this.getSeconds().toString();return yyyy+"-"+(mm[1]?mm:"0"+mm[0])+"-"+(dd[1]?dd:"0"+dd[0])+" "+(h[1]?h:"0"+h[0])+":"+(m[1]?m:"0"+m[0])+":"+(s[1]?s:"0"+s[0])},$scope.endCampaignTest=function(){$scope.clearMessage();var campaignQueue=getSelectedItems(),requestQueue=[];0===campaignQueue.length?(msg={header:"tab_campaigns_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()):(angular.forEach(campaignQueue,function(campaign){var currentdate=(campaign.entry_id,new Date),tmp=new Date(Date.parse(currentdate)),tmp1=(tmp.yyyymmdd(),new Date(Date.parse(currentdate)));tmp1.setDate(tmp1.getDate()-7);var ret1=tmp1.yyyymmdd();data={ends:ret1,pledge_processing_started:ret1},requestQueue.push(Restangular.one("campaign",campaign.id).customPUT(data).then(function(success){campaign=success,$scope.syncCampaignandFeatured(campaign.id,"ends",ret1)}))}),$q.all(requestQueue).then(function(){msg={header:"tab_campaigns_campaign_ended"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()},function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.endCampaign=function(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var campaignQueue=getSelectedItems(),requestQueue=[];0===campaignQueue.length?(msg={header:"tab_campaigns_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()):(angular.forEach(campaignQueue,function(campaign){var currentdate=(campaign.entry_id,new Date),tmp1=new Date(Date.parse(currentdate));tmp1.setDate(tmp1.getDate());var ret1=tmp1.yyyymmdd();data={ends:ret1,time_remaining:"00:00:00",days_remaining:0,hours_remaining:0,minutes_remaining:0,seconds_remaining:0,days_remaining_inclusive:0,hours_remaining_inclusive:0,minutes_remaining_inclusive:0,seconds_remaining_inclusive:0},requestQueue.push(Restangular.one("campaign",campaign.id).customPUT(data).then(function(success){campaign=success,$scope.syncCampaignandFeatured(campaign.id,"ends",ret1)}))}),$q.all(requestQueue).then(function(){msg={header:"tab_campaigns_campaign_ended"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()},function(failure){msg={header:failure.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}))},$scope.customEntryPerPage=function(number){$scope.sortOrFiltersCampaign.page_entries=number,updateCampaignListing($scope.sortOrFiltersCampaign)};for(var tmpList=[],i=1;i<=6;i++)tmpList.push({text:"Item "+i,value:i});$scope.list=tmpList,$scope.duringSort=0,$scope.showDropBlock=!0,$scope.campaignSortOptions={placeholder:"campaign-sortable-item",connectWith:".campaign-sortable",start:function(e,ui){$scope.duringSort=1},update:function(event,ui){},stop:function(event,ui){for(var i=0;i<$scope.campaign_buffer.length;i++)$scope.campaign_buffer[i].display_priority=4-i,Restangular.one("campaign",$scope.campaign_buffer[i].entry_id).customPUT($scope.campaign_buffer[i])}},$scope.getTime=function(campaign){$scope.timeStatusObj=TimeStatusService.getTimeStatus(campaign),campaign.timeStatNum=$scope.timeStatusObj.timeStatusNumber,campaign.timeStatText=$scope.timeStatusObj.timeStatusText,null==campaign.ends&&(campaign.timeStatNum="",$translate(["tab_campaign_campaign_continuous"]).then(function(value){campaign.timeStatText=value.tab_campaign_campaign_continuous}))},$scope.setCountry=function(country){$scope.selectedCountry.selected=country},$scope.deleteTransaction=function(){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg;var reqArr=[],arrCheckBox=$(".transactions-table-body").find(".ui.checkbox"),deleteSelectReward=!1;$.each(arrCheckBox,function(index,value){if($(value).hasClass("checked")){deleteSelectReward=!0;var campaignId=$scope.transaction_detail[index].backer[0].entry_id,req=Restangular.one("campaign",campaignId).customDELETE("pledge/"+$scope.transaction_detail[index].backer[0].entry_backer_id);reqArr.push(req)}}),$q.all(reqArr).then(function(success){$scope.showdetail($scope.cindex,$scope.cname,$scope.cstatus,$scope.ccurrency,$scope.total_backers,$scope.backer_offset),msg={header:"tab_campaigns_transactions_deleted_success"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),deleteSelectReward||(msg={header:"tab_campaigns_select_error"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage())},$scope.editTransaction=function(transaction){var backer=transaction.backer[0];if(transaction.editing=void 0!=transaction.editing&&transaction.editing,transaction.editing){var param={amount:backer.amount};Restangular.one("campaign",backer.entry_id).one("pledge",backer.entry_backer_id).customPUT(param).then(function(success){transaction=success})}transaction.editing=!transaction.editing},$scope.editTipTransaction=function(transaction){var backer=transaction.backer[0];if(transaction.tipEditing=void 0!=transaction.tipEditing&&transaction.tipEditing,transaction.tipEditing){var param={amount:backer.amount,amount_tip:backer.amount_tip};Restangular.one("campaign",backer.entry_id).one("pledge",backer.entry_backer_id).customPUT(param).then(function(success){transaction=success})}transaction.tipEditing=!transaction.tipEditing},$scope.$watch("selectedCity.selected",function(value,oldValue){value!=oldValue&&value&&(cityID=Geolocator.lookupCityID(value.name),cityID&&($scope.user.city_id=cityID),countryID=Geolocator.lookupCountryID(value.name),countryID&&($scope.user.country_id=countryID))}),$scope.$watch("selectedCountry.selected",function(value,oldValue){value!=oldValue&&value&&($scope.selectedCity.selected=void 0,$scope.selectedSubcountry.selected=void 0,getSubcountries(value.id))}),$scope.updateBackerOffset=function(){$(".small.backer-offset-modal.modal").modal({onHide:function(){},onShow:function(){},onApprove:function(){var data={backer_offset:$scope.backer_offset};Restangular.one("campaign",$scope.cid).customPUT(data).then(function(success){$scope.backer_offset=success.backer_offset})}}).modal("show")},$scope.toggleCampaignRevisionsView=function(){$scope.isCampaignRevisionsView=!$scope.isCampaignRevisionsView},$scope.selectRevisionItem=function(event,revisionData){$scope.selectedRevisions.push(revisionData)},$scope.deleteSelectedRevision=function(){for(var requestQueue=[],i=0;i<$scope.selectedRevisions.length;i++){var tempCampaignId=$scope.selectedRevisions[i].entry_id;Restangular.one("campaign",$scope.selectedRevisions[i].entry_id).one("resource-revision/file/").customGET().then(function(success){if(success.length){for(var campaignImages=[],campaignHeaderImages=[],i=0;i<success.length;i++)success[i].region_id==$scope.RESOURCE_REGIONS.campaign.thumbnail&&campaignImages.push(success[i]),success[i].region_id==$scope.RESOURCE_REGIONS.campaign.top_header&&campaignHeaderImages.push(success[i]);0!=campaignImages.length&&campaignImages[0].entry_file_revision_id&&Restangular.one("campaign",tempCampaignId).one("resource-revision/file").customDELETE(campaignImages[0].id),0!=campaignHeaderImages.length&&campaignHeaderImages[0].entry_file_revision_id&&Restangular.one("campaign",tempCampaignId).one("resource-revision/file").customDELETE(campaignHeaderImages[0].id)}}),Restangular.one("campaign",$scope.selectedRevisions[i].entry_id).one("faq-revision").getList().then(function(success){success.length&&success[0].faq_revision_id&&Restangular.one("campaign",tempCampaignId).one("faq-revision").customDELETE(success[0].faq_revision_id)}),requestQueue.push(Restangular.one("campaign",$scope.selectedRevisions[i].entry_id).one("setting-revision/bio_enable").customDELETE()),requestQueue.push(deleteRevisionById($scope.selectedRevisions[i].entry_id,$scope.selectedRevisions[i].entry_revision_id))}$q.all(requestQueue).then(function(){$scope.loadCampaignRevisions(),msg={header:"tab_campaigns_revision_delete_successful"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()},function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})},$scope.deleteAllRevisions=function(){for(var requestQueue=[],i=0;i<$scope.campaignRevisions.length;i++){var tempCampaignId=$scope.campaignRevisions[i].entry_id;Restangular.one("campaign",$scope.campaignRevisions[i].entry_id).one("resource-revision/file/").customGET().then(function(success){if(success.length){for(var campaignImages=[],campaignHeaderImages=[],i=0;i<success.length;i++)success[i].region_id==$scope.RESOURCE_REGIONS.campaign.thumbnail&&campaignImages.push(success[i]),success[i].region_id==$scope.RESOURCE_REGIONS.campaign.top_header&&campaignHeaderImages.push(success[i]);0!=campaignImages.length&&campaignImages[0].entry_file_revision_id&&Restangular.one("campaign",tempCampaignId).one("resource-revision/file").customDELETE(campaignImages[0].id),0!=campaignHeaderImages.length&&campaignHeaderImages[0].entry_file_revision_id&&Restangular.one("campaign",tempCampaignId).one("resource-revision/file").customDELETE(campaignHeaderImages[0].id)}}),Restangular.one("campaign",$scope.campaignRevisions[i].entry_id).one("faq-revision").getList().then(function(success){success.length&&success[0].faq_revision_id&&Restangular.one("campaign",tempCampaignId).one("faq-revision").customDELETE(success[0].faq_revision_id)}),requestQueue.push(Restangular.one("campaign",$scope.campaignRevisions[i].entry_id).one("setting-revision/bio_enable").customDELETE()),requestQueue.push(deleteRevisionById($scope.campaignRevisions[i].entry_id,$scope.campaignRevisions[i].entry_revision_id))}$q.all(requestQueue).then(function(){$scope.loadCampaignRevisions(),msg={header:"tab_campaigns_revision_delete_successful"},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()},function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()})}}]),app.filter("dateconv",["$filter",function($filter){return function(input){if(null==input)return"";var year=input.substring(0,4),month=input.substring(5,7),day=input.substring(8,10),d=(input.substring(11,13),input.substring(14,16),year+"-"+month+"-"+day);return d}}]);