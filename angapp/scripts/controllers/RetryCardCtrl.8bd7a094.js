app.controller("RetryCardCtrl",["$scope","$routeParams","$location","Restangular","UserService","$translatePartialLoader","$translate","StripeService","$timeout",function($scope,$routeParams,$location,Restangular,UserService,$translatePartialLoader,$translate,StripeService,$timeout){function repledge(data){Restangular.one("campaign",campaign_id).one("pledge-transaction",pledge_transaction_id).customPUT(data).then(function(success){$scope.retrySuccess=!0,$(".repledge-thank-you").modal("show")},function(failed){$scope.failedMessage=failed.data.message,$("#retrypledge").removeClass("disabled")})}$scope.card={};var userId=UserService.id,campaign_id=$routeParams.campaign_id,pledge_transaction_id=($routeParams.pledge_level_id,$routeParams.pledge_transaction_id);$scope.existedCards=[],$scope.cardSelected={},$scope.old_card_id="",$scope.new_card_id="",$scope.isAddingNewCard=!1;var existedStripeAccountCardId;$scope.$emit("loading_finished"),setTimeout(function(){$("#propagate").checkbox("check")},200),userId>0?(campaign_id&&Restangular.one("campaign",campaign_id).customGET().then(function(success){$scope.campaign=success}),pledge_transaction_id&&Restangular.one("campaign",campaign_id).one("pledge-transaction",pledge_transaction_id).customGET().then(function(success){$scope.failedContrib=success,$scope.old_card_id=$scope.failedContrib.stripe_account_card_id},function(failed){"account_campaign_permission_transaction_entry_backer"==failed.data.code?$(".ui.modal#wrong-account").modal({closable:!1}).modal("show"):"entity_not_found"==failed.data.code&&$(".ui.modal#not-found-transaction").modal({closable:!1}).modal("show")}),$scope.saveCard=function(){var not_validated=!$("#credit-card-info").form("validate form");if(!not_validated)if($("#retrypledge").addClass("disabled"),$scope.isAddingNewCard)StripeService.getPledgerAccount().then(function(account){var account_id=account[0].id,data={number:$scope.cardSelected.number,exp_month:$scope.cardSelected.exp_month,exp_year:$scope.cardSelected.exp_year,cvc:$scope.cardSelected.cvc,name:$scope.cardSelected.name};StripeService.createCard(account_id,data).then(function(card){var card_id=card.id;$scope.new_card_id=card.id;var data;data=$("#propagate").checkbox("is checked")?{stripe_account_card_id_previous:$scope.old_card_id,stripe_transaction_entry_backer_id:userId,stripe_account_card_id:card_id}:{stripe_transaction_entry_backer_id:userId,stripe_account_card_id:card_id},repledge(data)},function(failed){$scope.failedMessage=failed.data.message,$("#retrypledge").removeClass("disabled")})});else{var data;data=$("#propagate").checkbox("is checked")?{stripe_account_card_id_previous:$scope.old_card_id,stripe_transaction_entry_backer_id:userId,stripe_account_card_id:existedStripeAccountCardId}:{stripe_transaction_entry_backer_id:userId,stripe_account_card_id:existedStripeAccountCardId},repledge(data)}}):$location.path("/login"),$scope["goto"]=function(){$location.path("/explore")};var m_names=new Array("January","February","March","April","May","June","July","August","September","October","November","December"),currdate=new Date;$scope.currdate=m_names[currdate.getMonth()]+" "+currdate.getDate()+" "+currdate.getFullYear()+" "+currdate.getHours()+":"+currdate.getMinutes(),StripeService.getPledgerAccount().then(function(success){$scope.existedCards=success[0].cards,$scope.existedCards.length||($scope.isAddingNewCard=!0)}),$scope.setStripeCardId=function(stripe_account_card_id){existedStripeAccountCardId=stripe_account_card_id},$scope.toggleNewCard=function(){$scope.isAddingNewCard=!$scope.isAddingNewCard,$(".existing_cards .dropdown").dropdown("clear"),existedStripeAccountCardId=null},$scope.initStripePayment=function(){$timeout(function(){$("input[name='card-number']").payment("formatCardNumber"),$("input[name='cvc']").payment("formatCardCVC")},100)},$scope.hideNewCard=function(){$scope.isAddingNewCard=!1}}]);