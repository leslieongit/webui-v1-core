app.controller("InlineContributionCtrl",["$rootScope","$q","$location","$scope","$filter","$translatePartialLoader","$translate","UserService","StripeService","$routeParams","Restangular","Geolocator","RESOURCE_REGIONS","PortalSettingsService","$timeout","$sce","PHONE_TYPE","LANG",function($rootScope,$q,$location,$scope,$filter,$translatePartialLoader,$translate,UserService,StripeService,$routeParams,Restangular,Geolocator,RESOURCE_REGIONS,PortalSettingsService,$timeout,$sce,PHONE_TYPE,LANG){function setShippingVar(){$scope.alt_shipping=portal_settings.site_theme_alt_shipping_layout,$scope.native_lookup=portal_settings.site_theme_shipping_native_lookup,$scope.native_lookup&&(portal_settings.site_theme_default_shipping_country.name=portal_settings.site_theme_default_shipping_country.native_name),$scope.default_country=portal_settings.site_theme_default_shipping_country,null!=portal_settings.site_theme_default_shipping_country&&portal_settings.site_theme_default_shipping_country.name&&($scope.selectedCountry.selected=portal_settings.site_theme_default_shipping_country),$scope.setCountry($scope.selectedCountry.selected),$scope.selectedCountry.selected&&getSubcountries($scope.selectedCountry.selected.id),$scope.selectedReward&&$scope.selectedReward.shipping?getCountries().then(function(countries){var newCountries=[],worldShippingExist=!1,countryShippingList=[];angular.forEach($scope.selectedReward.shipping,function(value,key){1!=value.shipping_option_type_id&&3!=value.shipping_option_type_id||(worldShippingExist=!0),2==value.shipping_option_type_id&&countryShippingList.push(value)}),worldShippingExist||(angular.forEach(countryShippingList,function(item,key){angular.forEach(countries,function(country,key){item.country_id==country.id&&newCountries.push(country)})}),$scope.countries=newCountries)}):getCountries()}function setUpTipping(){Restangular.one("account/stripe/charge-amount").customGET().then(function(success){if(success[0]?($scope.lowestAmount=parseFloat(success[0].minimum_charge_amount),$scope.selectedTipCurrency?$scope.tipInfo=$scope.selectedTipCurrency:$scope.tipInfo=success[0]):($scope.lowestAmount=.5,$scope.campaign&&($scope.selectedTipCurrency?$scope.tipInfo=$scope.selectedTipCurrency:$scope.tipInfo=$scope.campaign.currencies[0])),$scope.tippingOptions.selectedTipDefault||($scope.tippingOptions.selectedTipDefault="tiers"),$scope.tippingOptions.toggle_dynamic&&!$scope.tippingOptions.toggle_tiers||"dynamic"==$scope.tippingOptions.selectedTipDefault)$scope.tip={value:null,dollar_amount:0,type:"Dollar",name:""},$scope.tippingOptions.toggle_dynamic_min_max&&$scope.tippingOptions.dynamic_min&&($scope.tip.value=$scope.tippingOptions.dynamic_min,$scope.tip.dollar_amount=$scope.tippingOptions.dynamic_min),$scope.selectedTipType="dynamic",$scope.tip={value:null,dollar_amount:0,type:"Dollar"},$scope.tippingOptions.toggle_dynamic_min_max&&$scope.tippingOptions.dynamic_min&&($scope.tip.value=$scope.tippingOptions.dynamic_min,$scope.tip.dollar_amount=$scope.tippingOptions.dynamic_min);else if($scope.tippingOptions.toggle_tiers||"tiers"==$scope.tippingOptions.selectedTipDefault){if($scope.tip={value:null,dollar_amount:0,type:"Dollar",name:""},$scope.tippingOptions.tiers[0]){$scope.updateTierValues();var dollarAmount=$scope.tippingOptions.tiers[0].dollar_amount;$scope.tip={value:$scope.tippingOptions.tiers[0].value,dollar_amount:dollarAmount,type:$scope.tippingOptions.tiers[0].type,name:$scope.tippingOptions.tiers[0].name}}$scope.selectedTipType="tiers"}else $scope.tippingOptions.toggle_dynamic||$scope.tippingOptions.toggle_tiers||!$scope.tippingOptions.toggle_no_tip||($scope.selectedTipType="no_tip",$scope.tip={value:null,dollar_amount:0,type:"Dollar"});if($scope.tippingOptions.toggle_no_tip&&"no_tip"==$scope.tippingOptions.selectedTipDefault&&($scope.selectedTipType="no_tip",$scope.tip={value:null,dollar_amount:0,type:"Dollar"}),$routeParams.tiptype)if($scope.selectedTipType=$routeParams.tiptype,"no_tip"==$scope.selectedTipType)$scope.tip={value:null,dollar_amount:0,type:"Dollar"};else if("tiers"==$scope.selectedTipType){if($scope.tiersIndex=0,$routeParams.tipindex&&($scope.tiersIndex=$routeParams.tipindex),$scope.tippingOptions.tiers[$scope.tiersIndex]){$scope.updateTierValues();var dollarAmount=$scope.tippingOptions.tiers[$scope.tiersIndex].value;"Percent"==$scope.tippingOptions.tiers[$scope.tiersIndex].type&&(dollarAmount=$scope.tippingOptions.tiers[$scope.tiersIndex].value/100*$scope.pledgeAmount,dollarAmount<$scope.lowestAmount&&(dollarAmount=$scope.lowestAmount)),$scope.tip={value:$scope.tippingOptions.tiers[$scope.tiersIndex].value,dollar_amount:dollarAmount,type:$scope.tippingOptions.tiers[$scope.tiersIndex].type,name:$scope.tippingOptions.tiers[$scope.tiersIndex].name}}}else"dynamic"==$scope.selectedTipType&&($scope.initialDynamicTip=0,$scope.tippingOptions.toggle_dynamic_min_max&&$scope.tippingOptions.dynamic_min&&($scope.initialDynamicTip=$scope.tippingOptions.dynamic_min),$scope.tip={value:$scope.initialDynamicTip,dollar_amount:$scope.initialDynamicTip,type:"Dollar",name:""},$routeParams.tipvalue&&($scope.tip={value:$routeParams.tipvalue,dollar_amount:$routeParams.tipvalue,type:"Dollar",name:""},$scope.tipValueInt=parseInt($routeParams.tipvalue),$scope.tippingOptions.toggle_dynamic_min_max&&($scope.tippingOptions.dynamic_min&&$scope.tipValueInt<$scope.tippingOptions.dynamic_min?($scope.tip.value=$scope.tippingOptions.dynamic_min,$scope.tip.dollar_amount=$scope.tippingOptions.dynamic_min):$scope.tippingOptions.dynamic_max&&$scope.tipValueInt>$scope.tippingOptions.dynamic_max&&($scope.tip.value=$scope.tippingOptions.dynamic_max,$scope.tip.dollar_amount=$scope.tippingOptions.dynamic_max))));"undefined"!=typeof $scope.tippingOptions&&$scope.tippingOptions.tiers&&$scope.tippingOptions.tiers.length&&($scope.tipTiersDefaultName=$scope.tippingOptions.tiers[0].name,$scope.tipTiersDefaultAmount=$scope.tippingOptions.tiers[0].dollar_amount,$routeParams.tipindex&&($scope.tipTiersDefaultName=$scope.tippingOptions.tiers[$routeParams.tipindex].name,$scope.tipTiersDefaultAmount=$scope.tippingOptions.tiers[$routeParams.tipindex].value))})}function loadCampaign(){Restangular.one("campaign").customGET($scope.campaign_id,{use_path_lookup:$routeParams.privatepath?1:0,path:$routeParams.privatepath}).then(function(success){$scope.$emit("loading_finished"),$scope.campaign=success,$rootScope.page_title=$scope.campaign.name?$scope.campaign.name+" - Inline Contribution":"Inline Contribution",$scope.campaign_loc=$scope.campaign.uri_paths[0].path,angular.forEach($scope.campaign.pledges,function(value,key){$scope.pledgeLevel==value.pledge_level_id&&($scope.pledgeindex=key,$scope.selectedReward=value,$scope.rname=$scope.campaign.pledges[$scope.pledgeindex].name)}),angular.forEach($scope.campaign.settings,function(value,index){var setting_name=value.name,setting_value=value.value;"name"!=setting_name&&($scope.campaign[setting_name]=setting_value)}),$scope.public_settings&&"undefined"!=typeof $scope.public_settings.site_theme_campaign_per_min&&$scope.public_settings.site_theme_campaign_per_min&&"undefined"!=typeof $scope.campaign.min_contribution&&($scope.public_settings.site_theme_campaign_min_contribute_amount=parseFloat($scope.campaign.min_contribution),$scope.pledgeAmount=parseFloat($scope.pledgeAmount),$scope.pledgeAmount<$scope.public_settings.site_theme_campaign_min_contribute_amount&&($scope.pledgeAmount=$scope.public_settings.site_theme_campaign_min_contribute_amount,$scope.campaignFundingGoal={value:$scope.pledgeAmount})),$scope.public_settings&&"undefined"!=typeof $scope.public_settings.site_theme_campaign_per_max&&$scope.public_settings.site_theme_campaign_per_max&&"undefined"!=typeof $scope.campaign.max_contribution&&($scope.max_amoumt=parseFloat($scope.campaign.max_contribution),$scope.allow_max=!0),$scope.public_settings&&"undefined"!=typeof $scope.public_settings.site_campaign_enable_organization_name&&$scope.public_settings.site_campaign_enable_organization_name&&Restangular.one('portal/person/attribute?filters={"person_id":"'+$scope.campaign.managers[0].id+'"}').customGET().then(function(success){$scope.organization_name.value=success[0].attributes.organization_name,$scope.organization_name.ein=success[0].attributes.ein}),$rootScope.campaign_path=$scope.campaign.uri_paths[0].path,setShippingVar()})}function setBrandIcon(brand,cardBrandToPfClass){var brandIconElement=document.getElementById("brand-icon"),pfClass="pf-credit-card";if(brand in cardBrandToPfClass)switch(pfClass=cardBrandToPfClass[brand],brand){case"visa":$("#brand-icon").css("background-image","url(images/cards/Visa.png)");break;case"mastercard":$("#brand-icon").css("background-image","url(images/cards/MasterCard.png)");break;case"amex":$("#brand-icon").css("background-image","url(images/cards/American%20Express.png)");break;case"dinersclub":$("#brand-icon").css("background-image","url(images/cards/diners.png)");break;case"discover":$("#brand-icon").css("background-image","url(images/cards/Discover.png)");break;case"jcb":$("#brand-icon").css("background-image","url(images/cards/jcb.png)");break;default:$("#brand-icon").css("background-image","url(images/cards/default-credit-card-icon.png)")}for(var i=brandIconElement.classList.length-1;i>=0;i--)brandIconElement.classList.remove(brandIconElement.classList[i]);brandIconElement.classList.add("pf"),brandIconElement.classList.add(pfClass)}function attributesValidation(){var translation=$translate.instant(["pledge_campaign_attribute_required_error"]);$("#reward-variation").find('input[name="variation_value"]').each(function(){$(this).val()?($scope.valcheck=$scope.valcheck&&!0,$(this).parent().parent(".field").removeClass("error"),$(this).parent().parent(".field").find(".error-text").remove()):($scope.valcheck=$scope.valcheck&&!1,$(this).parent().parent(".field").addClass("error"),$(this).parent().parent(".field").append('<div class="error-text ui red pointing prompt label">'+translation.pledge_campaign_attribute_required_error+"</div>"))}),$("#reward-variation").find('input[name="variation_value"]').change(function(){$scope.valcheck=$scope.valcheck&&!0,$(this).parent().parent(".field").removeClass("error"),$(this).parent().parent(".field").find(".error-text").remove()})}function phoneNumberValidation(){var translation=$translate.instant(["pledge_campaign_phone_required_error"]);$("#phone-number-form").form({phone_value:{identifier:"phone_value",rules:[{type:"empty",prompt:translation.pledge_campaign_phone_required_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")}function newPhoneNumberValidation(){var translation=$translate.instant(["pledge_campaign_new_phone_value_required_error","pledge_campaign_new_phone_type_required_error"]);$("#new-phone-number-form").form({new_phone_number:{identifier:"new_phone_number",rules:[{type:"empty",prompt:translation.pledge_campaign_new_phone_value_required_error}]},new_phone_type:{identifier:"new_phone_type",rules:[{type:"empty",prompt:translation.pledge_campaign_new_phone_type_required_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")}function errorHandling(failed){var msg={header:""};if(failed.data){if(failed.data.errors)for(var prop in failed.data.errors){msg.header=failed.data.errors[prop][0].code;break}else failed.data.type?msg.header=failed.data.message:msg.header=failed.data.code;msg.header=$translate.instant(msg.header),failed.hasOwnProperty("config")&&(failed.config.url.match(/\account\/stripe/)&&failed.config.url.match(/\account\/stripe/).length||failed.config.url.match(/pledge/)&&failed.config.url.match(/pledge/).length)&&(msg.header=$translate.instant("guest_account_registered_payment_failed")),$scope.failed_code=failed.data.code,console.error(failed.data.code),"account_campaign_transaction_max_allowed_funds_raised"===$scope.failed_code&&$translate("account_campaign_transaction_max_allowed_funds_raised").then(function(value){msg.header=value}),$rootScope.floatingMessage=msg}}function chooseShipping(address){if($scope.shipping_error=!1,$scope.shipOptions=[],"undefined"!=typeof $scope.selectedReward&&$scope.selectedReward.shipping){var len=$scope.selectedReward.shipping.length,count=0,found=!1;angular.forEach($scope.selectedReward.shipping,function(val){if(!found&&(val.country_id==address.country_id&&val.subcountry_id==address.subcountry_id&&3==val.shipping_option_type_id?($scope.shipOptions=[{shipping_option_type:val.shipping_option_type,country:val.country,sub_country:val.name,cost:val.cost}],count-=len,found=!0):count++,count==len)){var dummy=0;angular.forEach($scope.selectedReward.shipping,function(v){v.country_id==address.country_id&&2==v.shipping_option_type_id?($scope.shipOptions=[{shipping_option_type:v.shipping_option_type,country:v.country,sub_country:"",cost:v.cost}],dummy-=len,found=!0):dummy++,dummy==len&&(angular.forEach($scope.selectedReward.shipping,function(value){1==value.shipping_option_type_id&&($scope.shipOptions=[{shipping_option_type:value.shipping_option_type,country:"",sub_country:"",cost:value.cost}],found=!0)}),$scope.shipOptions.length<1&&($scope.shipping_error=!0))})}})}address&&address.hasOwnProperty("subcountry_id")&&setSubCountryAltShipping(address.subcountry_id)}function setSubCountryAltShipping(subcountry_id){$scope.alt_shipping&&$scope.site_campaign_alt_city_input_toggle&&Restangular.one("locale").customGET("city",{subcountry_id:subcountry_id}).then(function(success){success&&success.length&&($scope.address.city_id=success[0].city_id)})}function getSubcountries(countryID){Geolocator.getSubcountriesByCountry(countryID).then(function(subcountries){if($scope.native_lookup)for(var i in subcountries)null!=subcountries[i].native_name&&(subcountries[i].name=subcountries[i].native_name);$scope.subcountries=subcountries})}function getCountries(){return Geolocator.getCountries().then(function(countries){if($scope.native_lookup)for(var i in countries)null!=countries[i].native_name&&(countries[i].name=countries[i].native_name);if($scope.countries=countries,$scope.default_country){for(var index in $scope.countries){var value=$scope.countries[index];if(value.id==$scope.default_country.id){$scope.default_country=value,$scope.countries.splice(index,1);break}}$scope.countries.splice(0,0,$scope.default_country)}return $scope.countries})}function sendGATransaction(success,gaId){var ea={id:success.id,affiliation:$scope.campaign.name,revenue:success.amount,name:$scope.rname},name=$scope.rname?$scope.rname:"contribution",script="<script>ga('create','"+gaId+"', 'auto', {'name': 'ecommerceTracking'});ga('ecommerceTracking.require', 'ecommerce');ga('ecommerceTracking.ecommerce:addTransaction',{    'id': '"+ea.id+"',    'affiliation': '"+ea.affiliation+"',    'revenue': '"+ea.revenue+"',  });ga('ecommerceTracking.ecommerce:addItem',{    'id': '"+ea.id+"',    'price': '"+ea.revenue+"',    'name': '"+name+"',  });ga('ecommerceTracking.ecommerce:send');ga('send', 'pageview');</script>";$scope.gaScript=$sce.trustAsHtml(script)}var msg;$scope.RESOURCE_REGIONS=RESOURCE_REGIONS,window.a=$scope,$scope.organization_name={},$scope.pledgeLevel=$routeParams.plid,$scope.pledgeAmount=parseInt($routeParams.m),$scope.displayAmount=$scope.pledgeAmount,$scope.campaign_id=$routeParams.eid,$scope.selectedCity={},$scope.selectedSubcountry={},$scope.selectedCountry={},$scope.campaign_loc=$rootScope.currentLoc,$scope.chosenPhoneNumberId="",$scope.failed_submit=!1,$scope.accountInfo={},$scope.charity={},$scope.totalAmountPlusTip=0,$routeParams.attr&&($scope.selectedRewardAttrs=$routeParams.attr),$scope.phonetype=PHONE_TYPE,$scope.phoneInfo={number:"",phone_number_type_id:"",business_organization_id:"",person_id:""},$scope.newNumberCreated={number:"",phonetype:""},$scope.$watch("displayAmount",function(value){value&&(value=String(value).replace(/,/g,""),$scope.pledgeAmount=value)}),$scope.cardselected="Visa",$scope.cardID=1,$scope.cardtype=[{name:"Visa",id:1},{name:"American Express",id:2},{name:"Master Card",id:3},{name:"Discover",id:4}],$scope.toggle={newCard:!1,newAddress:!1,selectedCard:!1,selectedAddress:!1},$scope.campaignFundingGoal={value:$scope.pledgeAmount},$scope.stripeExtraDetails={address_city:"",address_country:"",address_line1:"",name:""},$scope.businessSelectedAttribute={business_contribution:0,business_organization_id:null},$scope.selectAccountCaptureType=1;var portal_settings;$("i").popup(),Restangular.one("portal/setting").getList().then(function(success){$scope.public_settings={},angular.forEach(success,function(value){3==value.setting_type_id&&($scope.public_settings[value.name]=value.value,$scope.payment_gateway=$scope.public_settings.site_payment_gateway,$scope.site_campaign_alt_city_input_toggle=$scope.public_settings.site_campaign_alt_city_input_toggle,$scope.public_settings.site_theme_campaign_min_contribute_amount&&($scope.public_settings.site_theme_campaign_min_contribute_amount=parseInt($scope.public_settings.site_theme_campaign_min_contribute_amount),$scope.pledgeAmount=parseInt($scope.pledgeAmount),$scope.pledgeAmount<$scope.public_settings.site_theme_campaign_min_contribute_amount&&($scope.pledgeAmount=$scope.public_settings.site_theme_campaign_min_contribute_amount)))}),"undefined"!=typeof $scope.public_setting.site_campaign_pledge_redirect&&$scope.public_setting.site_campaign_pledge_redirect?$scope.site_campaign_pledge_redirect=$scope.public_setting.site_campaign_pledge_redirect:$scope.site_campaign_pledge_redirect={toggle:!1,url:""},$scope.max_amoumt=parseInt($scope.public_settings.site_theme_campaign_max_contribute_amount),$scope.public_settings.site_theme_campaign_max_pledge_enabled&&"undefined"==typeof $scope.pledgeLevel&&($scope.allow_max=!0)},function(failed){msg={header:failed.data.message},$rootScope.floatingMessage=msg}),$scope.lowestAmount,$scope.tipInfo,$scope.tip={value:null,dollar_amount:0,type:"Dollar",name:""},$scope.tipTypeError=!1,PortalSettingsService.getSettingsObj().then(function(success){portal_settings=success.public_setting,$scope.allowDecimalNotation=portal_settings.site_campaign_decimal_option,$scope.contributionTypeRadio=portal_settings.site_theme_campaign_contribution_type_radio,$scope.anonymousContributionTypeOnly=portal_settings.site_campaign_anonymous_contribution_type_only,$scope.enableRewardVariation=portal_settings.site_theme_campaign_show_reward_enable_variation,$scope.charity_percentage_fee=portal_settings.site_campaign_charity_helper_percentage,$scope.isEnableContributionMessage=portal_settings.site_campaign_allow_contribution_message,$scope.isContributionLayout1=portal_settings.site_campaign_contribution_layout_toggle_1,$scope.isExpressCheckout=portal_settings.site_campaign_express_toggle,$scope.site_stripe_tokenization_settings=portal_settings.site_stripe_tokenization,$scope.selectedTipCurrency=portal_settings.site_tip_currency,$scope.acceptExtraPledgeData=portal_settings.site_campaign_profile_data_on_pledge,$scope.tippingOptions=portal_settings.site_tipping,$scope.displayCampaignDisclaimer=success.public_setting.site_campaign_campaign_toggle_disclaimer_text,$scope.forceAnonymousPledge=portal_settings.site_campaign_always_anonymous_contribution,"undefined"!=typeof $scope.tippingOptions&&null!=$scope.tippingOptions||($scope.tippingOptions={toggle:!1}),$scope.tippingOptions.hasOwnProperty("toggle")&&$scope.tippingOptions.toggle&&setUpTipping(),"undefined"!=typeof $scope.site_stripe_tokenization_settings&&null!=$scope.site_stripe_tokenization_settings||($scope.site_stripe_tokenization_settings={public_stripe_key:"",toggle:!1}),$scope.anonymousContributionTypeOnly?$scope.selecteContribution=!1:$scope.selecteContribution="contribution_type_regular",$scope.onlyOneOptionHide=!1,$scope.guest_contrib_option=success.public_setting.site_contribute_behaviour["default"],1==$scope.guest_contrib_option||3==$scope.guest_contrib_option||6==$scope.guest_contrib_option||8==$scope.guest_contrib_option?$scope.guestOption=1:2==$scope.guest_contrib_option||7==$scope.guest_contrib_option?$scope.guestOption=3:5==$scope.guest_contrib_option&&($scope.guestOption=4),$scope.pledgeLevel&&7==$scope.guest_contrib_option&&($scope.guestOption=4,$scope.onlyOneOptionHide=!0),5!=$scope.guest_contrib_option&&2!=$scope.guest_contrib_option||($scope.onlyOneOptionHide=!0),portal_settings.site_campaign_always_anonymous_contribution&&($scope.contribution=$scope.contribution.slice($scope.contribution.length-1),$scope.anonymous_contribution=1,$scope.partial_anonymous_contribution=0),"undefined"!=typeof $scope.accountInformationCapture&&$scope.accountInformationCapture||($scope.accountInformationCapture=[{name:"Individual",translation:"guest_contribution_account_type_individual"},{name:"Organization",translation:"guest_contribution_account_type_organization"}]),loadCampaign()}),$scope.contribution=[{name:"contribution_type_regular",type:1},{name:"contribution_type_partiallyanon",type:3},{name:"contribution_type_fullyanon",type:2}],$scope.cardTypeSelected=function(type){$scope.cardselected=type.name,$scope.cardID=type.id},$scope.contributionSelectionHelp="Contribution Selection 1 is selected",$scope.contributionSelected=function(type){$scope.selecteContribution=type.type,1==$scope.selecteContribution?$scope.contributionSelectionHelp="Contribution Selection 1 is selected":2==$scope.selecteContribution?$scope.contributionSelectionHelp="Contribution Selection 2 is selected":3==$scope.selecteContribution&&($scope.contributionSelectionHelp="Contribution Selection 3 is selected"),$(".help-popup").popup({content:$scope.contributionSelectionHelp,on:"click"})},$scope.accountTypeSelected=function(type){"Individual"==type.name?$scope.selectAccountCaptureType=1:$scope.selectAccountCaptureType=2},$scope.initStripeElement=function(){var translation=$translate.instant(["pledge_campaign_stripe_elements_cardExpirey","pledge_campaign_stripe_elements_cardNumber","pledge_campaign_creditcard_cvc_placeholder"]);$scope.stripe=Stripe($scope.site_stripe_tokenization_settings.public_stripe_key),$scope.elements=$scope.stripe.elements();var cardBrandToPfClass={visa:"pf-visa",mastercard:"pf-mastercard",amex:"pf-american-express",discover:"pf-discover",diners:"pf-diners",jcb:"pf-jcb",unknown:"pf-credit-card"},style={base:{iconColor:"#A3A3A3",color:"#000000",lineHeight:"16px",fontWeight:400,fontFamily:'Lato,"Helvetica Neue0",Arial,Helvetica,sans-serif',fontSize:"14px","::placeholder":{color:"#A3A3A3"}},invalid:{color:"#d95c5c",":focus":{color:"#d95c5c"}}};$scope.cardNumberElement=$scope.elements.create("cardNumber",{placeholder:translation.pledge_campaign_stripe_elements_cardNumber,iconStyle:"solid",style:style}),$scope.cardNumberElement.mount("#card-number-element"),$scope.cardExpiryElement=$scope.elements.create("cardExpiry",{placeholder:translation.pledge_campaign_stripe_elements_cardExpirey,iconStyle:"solid",style:style}),$scope.cardExpiryElement.mount("#card-expiry-element"),$scope.cardCvcElement=$scope.elements.create("cardCvc",{placeholder:translation.pledge_campaign_creditcard_cvc_placeholder,iconStyle:"solid",style:style}),$scope.cardCvcElement.mount("#card-cvc-element"),$scope.cardNumberElement.addEventListener("change",function(event){var displayError=angular.element("#card-errors");event.error?displayError.textContent=event.error.message:displayError.textContent="",event.brand&&setBrandIcon(event.brand,cardBrandToPfClass)}),$("#brand-icon").css("background-image","url(images/cards/default-credit-card-icon.png)")},$scope.isAGift=function(type){$scope.selecteContribution=type.type,1==$scope.selecteContribution?$scope.contributionSelectionHelp="Contribution Selection 1 is selected":2==$scope.selecteContribution?$scope.contributionSelectionHelp="Contribution Selection 2 is selected":3==$scope.selecteContribution&&($scope.contributionSelectionHelp="Contribution Selection 3 is selected"),$(".help-popup").popup({content:$scope.contributionSelectionHelp,on:"click"})},$scope.checkContribution=function(){2==$scope.selecteContribution?$scope.anonymous_contribution=!0:$scope.anonymous_contribution=!1,3==$scope.selecteContribution?$scope.partial_anonymous_contribution=1:$scope.partial_anonymous_contribution=0,1==$scope.selecteContribution&&($scope.anonymous_contribution=!1,$scope.partial_anonymous_contribution=0)},$scope.dropdownReset=function(selector){".address-select"==selector?$scope.selectedAddress=null:$scope.selectedCardID=null,$(selector).dropdown("restore defaults")},$scope.address={city_id:"",mail_code:"",street1:"",street2:"",country_id:""},$scope.creditCard={number:"",exp_month:"",exp_year:"",cvc:"",name:"",inline_token:"",card_token:""},$scope.person={fname:"",lname:"",address1:"",zip:"",number:"",occupation:"",email:"",employer:""},$scope.express={fname:"",lname:"",email:""},$scope.guestinfo={},$scope.checkCardType=function(){var cardNumber=$scope.creditCard.number,cardType=($.payment.validateCardNumber(cardNumber),$.payment.cardType(cardNumber)),$card=$("input.creditCardNumber");switch(cardType){case"visa":$card.css("background","#fff url(images/cards/Visa.png) no-repeat right 10px center");break;case"mastercard":$card.css("background","#fff url(images/cards/MasterCard.png) no-repeat right 10px center");break;case"amex":$card.css("background","#fff url(images/cards/American%20Express.png) no-repeat right 10px center");break;case"dinersclub":$card.css("background","#fff url(images/cards/diners.png) no-repeat right 10px center");break;case"discover":$card.css("background","#fff url(images/cards/Discover.png) no-repeat right 10px center");break;case"jcb":$card.css("background","#fff url(images/cards/jcb.png) no-repeat right 10px center");break;default:$card.css("background-image","none")}},$scope.initStripePayment=function(){$("input.creditCardNumber").payment("formatCardNumber"),$("input.cardCVC").payment("formatCardCVC")},$(".help-popup").popup({content:$scope.contributionSelectionHelp,on:"click"}),$scope.createNewAccExpressValidation=function(){var translation=$translate.instant(["guest_contribution_new_first_name_error","guest_contribution_new_last_name_error","guest_contribution_new_email_error","guest_contribution_new_email_error2"]);$(".express-form.ui.form").form({first_name:{identifier:"first_name",rules:[{type:"empty",prompt:translation.guest_contribution_new_first_name_error}]},last_name:{identifier:"last_name",rules:[{type:"empty",prompt:translation.guest_contribution_new_last_name_error}]},email:{identifier:"email",rules:[{type:"empty",prompt:translation.guest_contribution_new_email_error},{type:"email",prompt:translation.guest_contribution_new_email_error2}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.createNewAccValidation=function(){var translation=$translate.instant(["guest_contribution_new_first_name_error","guest_contribution_new_last_name_error","guest_contribution_new_email_error","guest_contribution_new_password_error","guest_contribution_new_confirm_password_error","guest_contribution_new_match_password_error","login_page_password_length","guest_contribution_new_email_error2"]);$(".create-new-account-info-form.ui.form").form({first_name:{identifier:"first_name",rules:[{type:"empty",prompt:translation.guest_contribution_new_first_name_error}]},last_name:{identifier:"last_name",rules:[{type:"empty",prompt:translation.guest_contribution_new_last_name_error}]},email:{identifier:"email",rules:[{type:"empty",prompt:translation.guest_contribution_new_email_error},{type:"email",prompt:translation.guest_contribution_new_email_error2}]},password:{identifier:"password",rules:[{type:"empty",prompt:translation.guest_contribution_new_password_error},{type:"length[6]",prompt:translation.login_page_password_length}]},confirm_password:{identifier:"confirm_password",rules:[{type:"empty",prompt:translation.guest_contribution_new_confirm_password_error},{type:"match[password]",prompt:translation.guest_contribution_new_match_password_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.guestCheckoutValidation=function(){var translation=$translate.instant(["guest_contribution_new_email_error","guest_contribution_new_email_error2","guest_contribution_password_error"]);$(".guest-info-form.ui.form").form({email:{identifier:"email",rules:[{type:"empty",prompt:translation.guest_contribution_new_email_error},{type:"email",prompt:translation.guest_contribution_new_email_error2}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.createNewCardValidation=function(){var translation=$translate.instant(["guest_contribution_new_card_number_error","guest_contribution_new_exp_month_error","guest_contribution_new_exp_year_error","guest_contribution_new_cvc_error"]);$(".credit-card-form.ui.form").form({card_number:{identifier:"card_number",rules:[{type:"empty",prompt:translation.guest_contribution_new_card_number_error}]},card_exp_month:{identifier:"card_exp_month",rules:[{type:"empty",prompt:translation.guest_contribution_new_exp_month_error}]},card_exp_year:{identifier:"card_exp_year",rules:[{type:"empty",prompt:translation.guest_contribution_new_exp_year_error}]},card_cvc:{identifier:"cvc",rules:[{type:"empty",prompt:translation.guest_contribution_new_cvc_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.newAddressFormValidation=function(){var translation=$translate.instant(["guest_contribution_shipping_country_error","guest_contribution_shipping_subcountry_error","guest_contribution_shipping_city_error","guest_contribution_shipping_mailcode_error","guest_contribution_shipping_streetaddress_error","guest_contribution_selectcity_error"]),validation={country:{identifier:"country",rules:[{type:"empty",prompt:translation.guest_contribution_shipping_country_error}]},mail_code:{identifier:"mail_code",rules:[{type:"empty",prompt:translation.guest_contribution_shipping_mailcode_error}]},street_address:{identifier:"street_address",rules:[{type:"empty",prompt:translation.guest_contribution_shipping_streetaddress_error}]}};$scope.site_campaign_alt_city_input_toggle?validation.city={identifier:"city",rules:[{type:"empty",prompt:translation.guest_contribution_selectcity_error}]}:$("#select-city .select2-container").hasClass("select2-container-disabled")||$scope.selectedCity.selected||$scope.site_campaign_alt_city_input_toggle||($("#select-city .select-error").remove(),$("#select-city").append('<div class="select-error ui red pointing prompt label transition visible">'+translation.guest_contribution_selectcity_error+"</div>"),$("#select-city").addClass("error")),$(".new-shipping-address-form.ui.form").form(validation,{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.newBusinessFormValidation=function(){var translation=$translate.instant(["guest_contribution_business_organization_error"]);$(".create-new-business-info-form.ui.form").form({organization_name:{identifier:"organization_name",rules:[{type:"empty",prompt:translation.guest_contribution_business_organization_error}]},organization_email:{identifier:"organization_email",rules:[{type:"empty",prompt:translation.guest_contribution_business_organization_email_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.contributeAmountValidation=function(){$.fn.form.settings.rules.under_minimum=function(value){return!($scope.pledgeAmount<$scope.public_settings.site_theme_campaign_min_contribute_amount);
},$.fn.form.settings.rules.over_maximum=function(value){return!($scope.pledgeAmount>$scope.max_amoumt&&$scope.allow_max)};var translation=$translate.instant(["pledge_campaign_contribution_empty","pledge_campaign_contribution_under_minimum","pledge_campaign_contribution_over_maximum"]);2==$scope.allowDecimalNotation||3==$scope.allowDecimalNotation?$(".contribution-form.ui.form").form({contribution_amount:{identifier:"contribution_amount",rules:[{type:"empty",prompt:translation.pledge_campaign_contribution_empty},{type:"under_minimum",prompt:translation.pledge_campaign_contribution_under_minimum},{type:"over_maximum",prompt:translation.pledge_campaign_contribution_over_maximum}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form"):$(".contribution-form.ui.form").form({contribution_amount:{identifier:"contribution_amount_decimal",rules:[{type:"empty",prompt:translation.pledge_campaign_contribution_empty},{type:"under_minimum",prompt:translation.pledge_campaign_contribution_under_minimum},{type:"over_maximum",prompt:translation.pledge_campaign_contribution_over_maximum}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")},$scope.tipValidation=function(){if(!$scope.selectedTipType)return $scope.tipTypeError=!0,void($scope.valcheck=$scope.valcheck&&!1);if($.fn.form.settings.rules.tip_zero=function(value){return 0!=$scope.tip.dollar_amount},$.fn.form.settings.rules.tip_number=function(value){if($scope.tip.dollar_amount)return!!$scope.tip.dollar_amount.match(/^[0-9]\d*(((,\d{3}){1})?(\.\d{0,2})?)$/)},$.fn.form.settings.rules.tip_under_minimum=function(value){return!$scope.tippingOptions.dynamic_min||!(Number($scope.tip.dollar_amount)<Number($scope.tippingOptions.dynamic_min))},$.fn.form.settings.rules.tip_over_maximum=function(value){return!$scope.tippingOptions.dynamic_max||!(Number($scope.tip.dollar_amount)>Number($scope.tippingOptions.dynamic_max))},"dynamic"==$scope.selectedTipType){var translation=$translate.instant(["pledge_campaign_tip_empty","pledge_campaign_tip_invalid","pledge_campaign_tip_under_minimum","pledge_campaign_tip_over_maximum"]);$scope.tippingOptions.toggle_dynamic_min_max?$(".dynamic-tipping-form.ui.form").form({dynamic_tip:{identifier:"dynamic_tip",rules:[{type:"empty",prompt:translation.pledge_campaign_tip_empty},{type:"tip_zero",prompt:translation.pledge_campaign_tip_empty},{type:"tip_number",prompt:translation.pledge_campaign_tip_invalid},{type:"tip_under_minimum",prompt:translation.pledge_campaign_tip_under_minimum},{type:"tip_over_maximum",prompt:translation.pledge_campaign_tip_over_maximum}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form"):$(".dynamic-tipping-form.ui.form").form({dynamic_tip:{identifier:"dynamic_tip",rules:[{type:"empty",prompt:translation.pledge_campaign_tip_empty},{type:"tip_zero",prompt:translation.pledge_campaign_tip_empty},{type:"tip_number",prompt:translation.pledge_campaign_tip_invalid}]}},{inline:!0,onSuccess:function(){$scope.valcheck=$scope.valcheck&&!0},onFailure:function(){$scope.valcheck=$scope.valcheck&&!1}}).form("validate form")}},$scope.clearForm=function(){$('.personal-info-fields .ui.form:not(".contribution-form")').form("clear").removeClass("error"),$scope.tos_not_checked=!1},$scope.submitWidgetPledge=function(){var invalid_elements=$("form, ng-form").find(".ng-invalid,.has-error");if(!(invalid_elements.length>0))if($scope.responseMsg="",$scope.checkContribution(),$scope.response=!1,$scope.totalAmount<=1)$scope.responseMsg="Donation Amount must be a number and atleast greater than 1 dollar";else{$("div.loader").addClass("active");if($("#finalpledge").addClass("disabled"),2==$scope.guestOption&&!$scope.registering_user){var data={first_name:$scope.accountInfo.first_name,last_name:$scope.accountInfo.last_name,email:$scope.accountInfo.email,password:$scope.accountInfo.password,password_confirm:$scope.accountInfo.password_confirm,inline_registration:!0};Restangular.one("register").customPOST(data).then(function(success){$scope.registering_user=success,$scope.creditCard.inline_token=$scope.registering_user.inline_token;var pledgeInfo={entry_id:$scope.campaign_id,number:$scope.creditCard.number,cvc:$scope.creditCard.cvc,exp_month:$scope.creditCard.exp_month,exp_year:$scope.creditCard.exp_year,amount:$scope.totalAmount,first_name:$scope.accountInfo.first_name,last_name:$scope.accountInfo.last_name,email:$scope.accountInfo.email,personal_address_line1:$scope.person.address1,personal_address_zip:$scope.person.zip,personal_city_id:$scope.city_id,personal_phone_number:$scope.person.number,occupation:$scope.person.occupation||"",employer:$scope.person.employer||"",inline_token:$scope.registering_user.inline_token};$scope.tippingOptions.toggle&&$scope.tip.dollar_amount&&0!=$scope.tip.dollar_amount&&(pledgeInfo.amount_tip=parseFloat($scope.tip.dollar_amount).toFixed(2),$scope.tippingOptions.toggle_process_tips_immediately&&(pledgeInfo.force_tip_processing=!0)),Restangular.one("account/widgetmakr").customPOST(pledgeInfo).then(function(success){$scope.wcardID=success.cards[0].widgetmakr_account_card_id,$scope.ctype=success.cards[0].widgetmakr_account_card_type;var infoPledge={widgetmakr_account_card_id:$scope.wcardID,amount:$scope.totalAmount,inline_token:$scope.registering_user.inline_token,anonymous_contribution:$scope.anonymous_contribution,anonymous_contribution_partial:$scope.partial_anonymous_contribution};Restangular.one("campaign",$scope.campaign_id).one("pledge").customPOST(infoPledge).then(function(success){$(".pledge-thank-you").modal({selector:{close:".actions .button",deny:".actions .negative, .actions .deny, .actions .cancel, .close"},closable:!1}).modal("show");var data={campaign_backer:1};UserService.updateUserData(data),$scope.public_settings.site_campaign_ecommerce_analytics&&$scope.public_settings.site_campaign_ecommerce_analytics.toggle&&sendGATransaction(success,$scope.public_settings.site_campaign_ecommerce_analytics.code)},function(failed){$("#finalpledge").removeClass("disabled")})},function(failed){$("#finalpledge").removeClass("disabled"),"Provided credit card number appears to be invalid."==failed.data.message&&($scope.responseMsg="Provided credit card number appears to be invalid"),"Invalid Card Expiration Date."===failed.data.message&&($scope.responseMsg="Invalid Card Expiration Date"),"Donation Amount must be a number and at least 1 dollar"===failed.data.message&&($scope.responseMsg="Donation Amount must be a number and  atleast greater than 1 dollar"),"Ccv can only contain numbers."===failed.data.message&&($scope.responseMsg="Ccv can only contain numbers"),"Validation failed for one or more entities. See 'EntityValidationErrors' property for more details."===failed.data.message&&($scope.responseMsg="Pledge failed")})},function(failed){$("#finalpledge").removeClass("disabled"),failed.data.errors.password_verification&&"register_invalid_password_mismatch"===failed.data.errors.password_verification[0].code&&($scope.responseMsg="Provided passwords do not match"),failed.data.errors.email&&("account_campaign_invalid_email"===failed.data.errors.email[0].code&&($scope.responseMsg="Email filed is not valid"),"register_invalid_email_exists"===failed.data.errors.email[0].code&&($scope.responseMsg="Provided email address has already been registered"))})}if(3==$scope.guestOption){var pledgeInfo={entry_id:$scope.campaign_id,number:$scope.creditCard.number,cvc:$scope.creditCard.cvc,exp_month:$scope.creditCard.exp_month,exp_year:$scope.creditCard.exp_year,amount:$scope.totalAmount,first_name:$scope.accountInfo.first_name,last_name:$scope.accountInfo.last_name,email:$scope.accountInfo.email,personal_address_line1:$scope.person.address1,personal_address_zip:$scope.person.zip,personal_city_id:$scope.city_id,personal_phone_number:$scope.person.number,occupation:$scope.person.occupation||"",employer:$scope.person.employer||""};$scope.tippingOptions.toggle&&$scope.tip.dollar_amount&&0!=$scope.tip.dollar_amount&&(pledgeInfo.amount_tip=parseFloat($scope.tip.dollar_amount).toFixed(2),$scope.tippingOptions.toggle_process_tips_immediately&&(pledgeInfo.force_tip_processing=!0)),$scope.infoPledge={amount:"",card_id:"",email:"",fingerprint:"",use_widgetmakr:""},Restangular.one("account/widgetmakr/guest").customPOST(pledgeInfo).then(function(success){success.card_id&&($scope.wcardID=success.card_id,$scope.fingerprint=success.fingerprint,$scope.infoPledge={amount:$scope.totalAmount,card_id:$scope.wcardID,email:$scope.accountInfo.email,fingerprint:$scope.fingerprint,use_widgetmakr:1}),Restangular.one("campaign",$scope.campaign_id).one("pledge/guest").customPOST($scope.infoPledge).then(function(success){$translate("Pledge_Success").then(function(value){$scope.responseMsg=value}),$(".pledge-thank-you").modal({selector:{close:".actions .button",deny:".actions .negative, .actions .deny, .actions .cancel, .close"}}).modal("show");var data={campaign_backer:1};UserService.updateUserData(data)},function(failed){$("#finalpledge").removeClass("disabled"),failed.data.errors.email&&("account_campaign_invalid_email"===failed.data.errors.email[0].code&&($scope.responseMsg="Email filed is not valid"),"register_invalid_email_exists"===failed.data.errors.email[0].code&&($scope.responseMsg="Provided email address has already been registered"))})},function(failed){$("#finalpledge").removeClass("disabled"),"Provided credit card number appears to be invalid."==failed.data.message&&($scope.responseMsg="Provided credit card number appears to be invalid"),"Invalid Card Expiration Date."===failed.data.message&&($scope.responseMsg="Invalid Card Expiration Date"),"Donation Amount must be a number and at least 1 dollar"===failed.data.message&&($scope.responseMsg="Donation Amount must be a number and  atleast greater than 1 dollar"),"Ccv can only contain numbers."===failed.data.message&&($scope.responseMsg="Ccv can only contain numbers"),"Provided credit card number is too large."===failed.data.message&&($scope.responseMsg="Provided credit card number is too large"),"Validation failed for one or more entities. See 'EntityValidationErrors' property for more details."===failed.data.message&&($scope.responseMsg="Pledge failed"),"Invalid Credit Card Number."===failed.data.message&&($scope.responseMsg="Invalid Credit Card Number")})}if(4==$scope.guestOption){var rdm_pw=$scope.randomPasswordGenerator();if(!$scope.registering_user){var data={first_name:$scope.express.fname,last_name:$scope.express.lname,email:$scope.express.email,password:rdm_pw,password_confirm:rdm_pw,inline_registration:!0,express_checkout:!0};Restangular.one("register").customPOST(data).then(function(success){$scope.registering_user=success,$scope.creditCard.inline_token=$scope.registering_user.inline_token;var pledgeInfo={entry_id:$scope.campaign_id,number:$scope.creditCard.number,cvc:$scope.creditCard.cvc,exp_month:$scope.creditCard.exp_month,exp_year:$scope.creditCard.exp_year,amount:$scope.totalAmount,first_name:$scope.express.fname,last_name:$scope.express.lname,email:$scope.express.email,personal_address_line1:$scope.person.address1,personal_address_zip:$scope.person.zip,personal_city_id:$scope.city_id,personal_phone_number:$scope.person.number,occupation:$scope.person.occupation||"",employer:$scope.person.employer||"",inline_token:$scope.registering_user.inline_token,anonymous_contribution:$scope.anonymous_contribution,anonymous_contribution_partial:$scope.partial_anonymous_contribution};$scope.tippingOptions.toggle&&$scope.tip.dollar_amount&&0!=$scope.tip.dollar_amount&&(pledgeInfo.amount_tip=parseFloat($scope.tip.dollar_amount).toFixed(2),$scope.tippingOptions.toggle_process_tips_immediately&&(pledgeInfo.force_tip_processing=!0)),Restangular.one("account/widgetmakr").customPOST(pledgeInfo).then(function(success){$scope.wcardID=success.cards[0].widgetmakr_account_card_id,$scope.ctype=success.cards[0].widgetmakr_account_card_type;var infoPledge={widgetmakr_account_card_id:$scope.wcardID,amount:$scope.totalAmount,inline_token:$scope.registering_user.inline_token,anonymous_contribution:$scope.anonymous_contribution,anonymous_contribution_partial:$scope.partial_anonymous_contribution};Restangular.one("campaign",$scope.campaign_id).one("pledge").customPOST(infoPledge).then(function(success){$(".pledge-thank-you").modal({selector:{close:".actions .button",deny:".actions .negative, .actions .deny, .actions .cancel, .close"},closable:!1}).modal("show");var data={campaign_backer:1};UserService.updateUserData(data),$scope.public_settings.site_campaign_ecommerce_analytics&&$scope.public_settings.site_campaign_ecommerce_analytics.toggle&&sendGATransaction(success,$scope.public_settings.site_campaign_ecommerce_analytics.code)},function(failed){$("#finalpledge").removeClass("disabled")})},function(failed){$("#finalpledge").removeClass("disabled"),"Provided credit card number appears to be invalid."==failed.data.message&&($scope.responseMsg=$translate.instant("guest_contribution_invalid_cc")),"Invalid Card Expiration Date."===failed.data.message&&($scope.responseMsg=$translate.instant("guest_contribution_invalid_cc_expired")),"Donation Amount must be a number and at least 1 dollar"===failed.data.message&&($scope.responseMsg=$translate.instant("guest_contribution_invalid_amount")),"Ccv can only contain numbers."===failed.data.message&&($scope.responseMsg=$translate.instant("guest_contribution_invalid_cvc_numbers_only")),"Validation failed for one or more entities. See 'EntityValidationErrors' property for more details."===failed.data.message&&($scope.responseMsg=$translate.instant("guest_contribution_invalid_entity"))})},function(failed){$("#finalpledge").removeClass("disabled"),failed.data.errors.password_verification&&"register_invalid_password_mismatch"===failed.data.errors.password_verification[0].code&&($scope.responseMsg="Provided passwords do not match"),failed.data.errors.email&&("account_campaign_invalid_email"===failed.data.errors.email[0].code&&($scope.responseMsg=$translate.instant("guest_contribution_invalid_email")),"register_invalid_email_exists"===failed.data.errors.email[0].code&&($scope.responseMsg=$translate.instant("guest_contribution_invalid_email_exists")))})}}}},$scope.phoneTypeSelected=function(type){$scope.newNumberCreated.phonetype=type},$scope.submit=function(){function addAddressPhoneNumber(business_organization_id,businessPromises,addressInfo,phoneInfo){business_organization_id&&($scope.address.business_organization_id=business_organization_id,$scope.phoneInfo.business_organization_id=business_organization_id),businessPromises.push(Restangular.one("account/address").customPOST(addressInfo)),businessPromises.push(Restangular.one("account/phone-number").customPOST(phoneInfo))}function generateTokenOrPledge(promises,pledgeAttributes,businessData){$scope.site_stripe_tokenization_settings.toggle?($scope.stripeExtraDetails.name=data.first_name+" "+data.last_name,$scope.pledgeLevel&&$scope.campaign.pledges[$scope.pledgeindex].shipping&&($scope.stripeExtraDetails.address_line1=$scope.address.street1),$scope.stripe.createToken($scope.cardNumberElement,$scope.stripeExtraDetails).then(function(result){result.error?(Restangular.one("account/person-inline-disable").customPUT({person_id:$scope.registering_user.id,inline_token:$scope.registering_user.inline_token}),$timeout(function(){$rootScope.removeFloatingMessage();angular.element(document.querySelector("#card-errors")).html(result.error.message);msg={header:"pledge_campaign_stripe_elements_error"},$rootScope.floatingMessage=msg,$("#pledgebutton").removeClass("disabled")},500)):($scope.creditCard.card_token=result.token.id,promises.push(StripeService.newPledgerAccount($scope.creditCard)),$scope.resolvePromiseChain(promises,pledgeAttributes,businessData))})):(promises.push(StripeService.newPledgerAccount($scope.creditCard)),$scope.resolvePromiseChain(promises,pledgeAttributes,businessData))}$scope.selecteContributionAnon&&($scope.selecteContribution=2);var pledgeAttributes={};if($scope.site_campaign_alt_city_input_toggle&&!$scope.alt_shipping&&($scope.address.city_id=258463),$scope.selectedReward&&$scope.selectedReward.attributes&&"undefined"!=typeof $scope.selectedReward.attributes.variation){var variation_choice=angular.copy($scope.selectedReward.attributes.variation);$('input[name="variation_value"]').each(function(key){""!=$(this).val()?variation_choice[key].choice=variation_choice[key].choice[$(this).val()].value:variation_choice[key].choice=null}),pledgeAttributes.variation=variation_choice}switch($scope.public_settings.site_campaign_charity_helper_enable&&($scope.charity.country&&($scope.charity.country_name=$scope.countries[$scope.charity.country-1].name),pledgeAttributes.charity=$scope.charity),$scope.valcheck=!0,$scope.guestOption=parseInt($scope.guestOption),$scope.guestOption){case 2:$scope.createNewAccValidation(),$scope.createNewCardValidation(),$scope.newAddressFormValidation(),$scope.acceptExtraPledgeData&&2==$scope.selectAccountCaptureType&&$scope.newBusinessFormValidation(),$scope.acceptExtraPledgeData&&newPhoneNumberValidation();break;case 3:$scope.guestCheckoutValidation(),$scope.createNewCardValidation(),$scope.stripeExtraDetailsValidation();break;case 4:$scope.createNewAccExpressValidation(),$scope.createNewCardValidation(),$scope.newAddressFormValidation(),$scope.acceptExtraPledgeData&&2==$scope.selectAccountCaptureType,$scope.acceptExtraPledgeData&&newPhoneNumberValidation()}if($scope.tippingOptions.toggle&&$scope.tipValidation(),$scope.public_settings.site_campaign_reward_attributes_required&&attributesValidation(),"number"==typeof $scope.pledgeindex&&$scope.public_settings.site_campaign_reward_phone_required&&$scope.campaign.pledges[$scope.pledgeindex].shipping&&1!=$scope.guestOption&&($scope.toggle.newNumber?phoneNumberValidation():newPhoneNumberValidation()),$scope.contributeAmountValidation(),!$scope.isContributionLayout1&&$scope.public_settings.site_tos_contribution_ui){if(!$('.agreement input[type="checkbox"]').is(":checked"))return $scope.tos_not_checked=!0,void $rootScope.scrollToError();$scope.tos_not_checked=!1}if($scope.valcheck){msg={loading:!0,loading_message:"in_progress"},$rootScope.floatingMessage=msg,$scope.checkContribution(),$("#pledgebutton").addClass("disabled");var promises=[];if(2==$scope.guestOption){var data={first_name:$scope.accountInfo.first_name,last_name:$scope.accountInfo.last_name,email:$scope.accountInfo.email,password:$scope.accountInfo.password,password_confirm:$scope.accountInfo.password_confirm,inline_registration:!0};Restangular.one("register").customPOST(data).then(function(success){$scope.registering_user=success,$scope.creditCard.inline_token=$scope.registering_user.inline_token;var businessData=null;if($scope.acceptExtraPledgeData){var bus_org_data={name:$scope.accountInfo.organization_name,email:$scope.accountInfo.organization_email,person_id:$scope.registering_user.person_id,inline_token:$scope.registering_user.inline_token};businessData={business_id:"",phone_id:"",address_id:""};var businessCreateOrganization=[],businessPromises=[];return 2==$scope.selectAccountCaptureType&&businessCreateOrganization.push(Restangular.one("account/business").customPOST(bus_org_data)),$scope.newNumberCreated.number.length>0&&$scope.newNumberCreated.phonetype&&($scope.phoneInfo.number=$scope.newNumberCreated.number,$scope.phoneInfo.phone_number_type_id=$scope.newNumberCreated.phonetype.id,$scope.phoneInfo.person_id=$scope.registering_user.id,$scope.phoneInfo.inline_token=$scope.registering_user.inline_token),$scope.address.street1&&($scope.address.inline_token=$scope.registering_user.inline_token),2==$scope.selectAccountCaptureType&&businessCreateOrganization.length&&$q.all(businessCreateOrganization).then(function(resolved){angular.forEach(resolved,function(value){businessData.business_id=value.business_organization_id,addAddressPhoneNumber(businessData.business_id,businessPromises,$scope.address,$scope.phoneInfo),$q.all(businessPromises).then(function(resolved){angular.forEach(resolved,function(value){value.address_id&&(businessData.address_id=value.address_id,$scope.selectedAddressID=value.address_id),value.phone_number_id&&(businessData.phone_id=value.phone_number_id,$scope.chosenPhoneNumberId=value.phone_number_id)}),generateTokenOrPledge(promises,pledgeAttributes,businessData)})})}),void(1==$scope.selectAccountCaptureType&&(addAddressPhoneNumber(null,businessPromises,$scope.address,$scope.phoneInfo),$q.all(businessPromises).then(function(resolved){angular.forEach(resolved,function(value){value.address_id&&(businessData.address_id=value.address_id,$scope.selectedAddressID=value.address_id),value.phone_number_id&&(businessData.phone_id=value.phone_number_id,$scope.chosenPhoneNumberId=value.phone_number_id)}),generateTokenOrPledge(promises,pledgeAttributes,businessData)})))}if($scope.pledgeLevel&&("undefined"!=typeof $scope.campaign.pledges[$scope.pledgeindex]&&$scope.campaign.pledges[$scope.pledgeindex].shipping&&($scope.address.inline_token=$scope.registering_user.inline_token,promises.push(Restangular.one("account/address").customPOST($scope.address))),$scope.newNumberCreated.number.length>0&&$scope.newNumberCreated.phonetype)){$scope.phoneInfo.number=$scope.newNumberCreated.number,$scope.phoneInfo.phone_number_type_id=$scope.newNumberCreated.phonetype.id,$scope.phoneInfo.person_id=$scope.registering_user.id,$scope.phoneInfo.inline_token=$scope.registering_user.inline_token;var phoneRequest=Restangular.one("account/phone-number").customPOST($scope.phoneInfo);phoneRequest.then(function(success){$scope.chosenPhoneNumberId=success.id}),promises.push(phoneRequest)}$scope.site_stripe_tokenization_settings.toggle?($scope.stripeExtraDetails.name=data.first_name+" "+data.last_name,$scope.pledgeLevel&&$scope.campaign.pledges[$scope.pledgeindex].shipping&&($scope.stripeExtraDetails.address_line1=$scope.address.street1),$scope.stripe.createToken($scope.cardNumberElement,$scope.stripeExtraDetails).then(function(result){result.error?(Restangular.one("account/person-inline-disable").customPUT({person_id:$scope.registering_user.id,inline_token:$scope.registering_user.inline_token}),$timeout(function(){$rootScope.removeFloatingMessage();angular.element(document.querySelector("#card-errors")).html(result.error.message);msg={header:"pledge_campaign_stripe_elements_error"},$rootScope.floatingMessage=msg,$("#pledgebutton").removeClass("disabled")},500)):($scope.creditCard.card_token=result.token.id,promises.push(StripeService.newPledgerAccount($scope.creditCard)),$scope.resolvePromiseChain(promises,pledgeAttributes))})):(promises.push(StripeService.newPledgerAccount($scope.creditCard)),$scope.resolvePromiseChain(promises,pledgeAttributes))},function(failed){$("#pledgebutton").removeClass("disabled"),errorHandling(failed)})}else if(4==$scope.guestOption){var rdm_pw=$scope.randomPasswordGenerator(),data={first_name:$scope.express.fname,last_name:$scope.express.lname,email:$scope.express.email,password:rdm_pw,password_confirm:rdm_pw,inline_registration:!0,express_checkout:!0};Restangular.one("register").customPOST(data).then(function(success){$scope.registering_user=success,$scope.creditCard.inline_token=$scope.registering_user.inline_token;var businessData=null;if($scope.acceptExtraPledgeData){var bus_org_data={name:$scope.accountInfo.organization_name,email:$scope.accountInfo.organization_email,person_id:$scope.registering_user.person_id,inline_token:$scope.registering_user.inline_token};businessData={business_id:"",phone_id:"",address_id:""};var businessCreateOrganization=[],businessPromises=[];return 2==$scope.selectAccountCaptureType&&businessCreateOrganization.push(Restangular.one("account/business").customPOST(bus_org_data)),$scope.newNumberCreated.number.length>0&&$scope.newNumberCreated.phonetype&&($scope.phoneInfo.number=$scope.newNumberCreated.number,$scope.phoneInfo.phone_number_type_id=$scope.newNumberCreated.phonetype.id,$scope.phoneInfo.person_id=$scope.registering_user.id,$scope.phoneInfo.inline_token=$scope.registering_user.inline_token),$scope.address.street1&&($scope.address.inline_token=$scope.registering_user.inline_token),2==$scope.selectAccountCaptureType&&businessCreateOrganization.length&&$q.all(businessCreateOrganization).then(function(resolved){angular.forEach(resolved,function(value){businessData.business_id=value.business_organization_id,addAddressPhoneNumber(businessData.business_id,businessPromises,$scope.address,$scope.phoneInfo),$q.all(businessPromises).then(function(resolved){angular.forEach(resolved,function(value){value.address_id&&(businessData.address_id=value.address_id,$scope.selectedAddressID=value.address_id),value.phone_number_id&&(businessData.phone_id=value.phone_number_id,$scope.chosenPhoneNumberId=value.phone_number_id)}),generateTokenOrPledge(promises,pledgeAttributes,businessData)})})}),void(1==$scope.selectAccountCaptureType&&(addAddressPhoneNumber(null,businessPromises,$scope.address,$scope.phoneInfo),$q.all(businessPromises).then(function(resolved){angular.forEach(resolved,function(value){value.address_id&&(businessData.address_id=value.address_id,$scope.selectedAddressID=value.address_id),value.phone_number_id&&(businessData.phone_id=value.phone_number_id,$scope.chosenPhoneNumberId=value.phone_number_id)}),generateTokenOrPledge(promises,pledgeAttributes,businessData)})))}if($scope.pledgeLevel&&("undefined"!=typeof $scope.campaign.pledges[$scope.pledgeindex]&&$scope.campaign.pledges[$scope.pledgeindex].shipping&&($scope.address.inline_token=$scope.registering_user.inline_token,promises.push(Restangular.one("account/address").customPOST($scope.address))),$scope.newNumberCreated.number.length>0&&$scope.newNumberCreated.phonetype)){$scope.phoneInfo.number=$scope.newNumberCreated.number,$scope.phoneInfo.phone_number_type_id=$scope.newNumberCreated.phonetype.id,$scope.phoneInfo.person_id=$scope.registering_user.id,$scope.phoneInfo.inline_token=$scope.registering_user.inline_token;var phoneRequest=Restangular.one("account/phone-number").customPOST($scope.phoneInfo);phoneRequest.then(function(success){$scope.chosenPhoneNumberId=success.id}),promises.push(phoneRequest)}$scope.site_stripe_tokenization_settings.toggle?($scope.stripeExtraDetails.name=data.first_name+" "+data.last_name,$scope.pledgeLevel&&$scope.campaign.pledges[$scope.pledgeindex].shipping&&($scope.stripeExtraDetails.address_line1=$scope.address.street1),$scope.stripe.createToken($scope.cardNumberElement,$scope.stripeExtraDetails).then(function(result){result.error?(Restangular.one("account/person-inline-disable").customPUT({person_id:$scope.registering_user.id,inline_token:$scope.registering_user.inline_token}),$timeout(function(){$rootScope.removeFloatingMessage();angular.element(document.querySelector("#card-errors")).html(result.error.message);msg={header:"pledge_campaign_stripe_elements_error"},$rootScope.floatingMessage=msg,$("#pledgebutton").removeClass("disabled")},500)):($scope.creditCard.card_token=result.token.id,promises.push(StripeService.newPledgerAccount($scope.creditCard)),$scope.resolvePromiseChain(promises,pledgeAttributes))})):(promises.push(StripeService.newPledgerAccount($scope.creditCard)),$scope.resolvePromiseChain(promises,pledgeAttributes))},function(failed){$("#pledgebutton").removeClass("disabled"),errorHandling(failed)})}else $scope.pledgeLevel&&$scope.campaign.pledges[$scope.pledgeindex].shipping&&promises.push(Restangular.one("account/address/guest").customPOST($scope.address)),$scope.site_stripe_tokenization_settings.toggle?(0==$scope.stripeExtraDetails.name.length&&($scope.stripeExtraDetails.name="guest"),$scope.stripe.createToken($scope.cardNumberElement,$scope.stripeExtraDetails).then(function(result){result.error?$timeout(function(){$rootScope.removeFloatingMessage();angular.element(document.querySelector("#card-errors")).html(result.error.message);msg={header:"pledge_campaign_stripe_elements_error"},$rootScope.floatingMessage=msg,$("#pledgebutton").removeClass("disabled")},500):($scope.creditCard.card_token=result.token.id,promises.push(StripeService.newGuestPledgerAccount($scope.creditCard)),$scope.resolveGuestPromiseChain(promises,pledgeAttributes))})):(promises.push(StripeService.newGuestPledgerAccount($scope.creditCard)),$scope.resolveGuestPromiseChain(promises,pledgeAttributes))}else $rootScope.scrollToError()},$scope.createTokenForRetryPledge=function(stripe_account_id,pledgeAttributes,creditCard){StripeService.createCard(stripe_account_id,creditCard).then(function(success){var pledgeInfo={stripe_account_card_id:success.id,pledge_level_id:$scope.pledgeLevel,amount:$scope.totalAmount,shipping_address_id:$scope.selectedAddressID||"",attributes:JSON.stringify(pledgeAttributes)};$scope.tippingOptions.toggle&&$scope.tip.dollar_amount&&0!=$scope.tip.dollar_amount&&(pledgeInfo.amount_tip=parseFloat($scope.tip.dollar_amount).toFixed(2),$scope.tippingOptions.toggle_process_tips_immediately&&(pledgeInfo.force_tip_processing=!0)),$scope.contributionMessage&&(pledgeInfo.note=$scope.contributionMessage),Restangular.one("campaign",$scope.campaign_id).one("pledge").customPOST(pledgeInfo).then(function(success){$translate("Pledge_Success").then(function(value){msg={header:value},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),$(".pledge-thank-you").modal({selector:{close:".actions .button",deny:".actions .negative, .actions .deny, .actions .cancel, .close"},closable:!1}).modal("show");var data={email:$scope.accountInfo.email,password:$scope.accountInfo.password};Restangular.one("authenticate").customPOST(data).then(function(success){UserService.setLoggedIn(success)}),$scope.public_settings.site_campaign_ecommerce_analytics&&$scope.public_settings.site_campaign_ecommerce_analytics.toggle&&sendGATransaction(success,$scope.public_settings.site_campaign_ecommerce_analytics.code)},function(failed){$("#pledgebutton").removeClass("disabled"),errorHandling(failed)})},function(failed){$("#pledgebutton").removeClass("disabled"),errorHandling(failed)})},$scope.resolveGuestPromiseChain=function(promises,pledgeAttributes){$q.all(promises).then(function(resolved){$scope.site_stripe_tokenization_settings.toggle,angular.forEach(resolved,function(value){value.card_id&&($scope.guest_card_id=value.card_id,$scope.guest_fingerprint=value.fingerprint),value.address_id&&($scope.selectedAddressID=value.address_id),value.business_organization_id&&($scope.selectedCompanyID=value.business_organization_id)}),$scope.acceptExtraPledgeData&&2==$scope.selectAccountCaptureType&&($scope.businessSelectedAttribute.business_contribution=1,$scope.businessSelectedAttribute.business_organization_id=$scope.selectedCompanyID,pledgeAttributes.business=$scope.businessSelectedAttribute);var pledgeInfo={pledge_level_id:$scope.pledgeLevel,amount:$scope.totalAmount,shipping_address_id:$scope.selectedAddressID||"",card_id:$scope.guest_card_id,fingerprint:$scope.guest_fingerprint,email:$scope.creditCard.email,last_name:$scope.creditCard.last_name,first_name:$scope.creditCard.first_name,attributes:JSON.stringify(pledgeAttributes)};$scope.contributionMessage&&(pledgeInfo.note=$scope.contributionMessage),$scope.tippingOptions.toggle&&$scope.tip.dollar_amount&&0!=$scope.tip.dollar_amount&&(pledgeInfo.amount_tip=parseFloat($scope.tip.dollar_amount).toFixed(2),$scope.tippingOptions.toggle_process_tips_immediately&&(pledgeInfo.force_tip_processing=!0)),Restangular.one("campaign",$scope.campaign_id).one("pledge/guest").customPOST(pledgeInfo).then(function(success){$translate("Pledge_Success").then(function(value){msg={header:value},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),$(".pledge-thank-you").modal({selector:{close:".actions .button",deny:".actions .negative, .actions .deny, .actions .cancel, .close"},
closable:!1}).modal("show"),"undefined"!=typeof $scope.campaign.settings&&$scope.campaign.contribution_redirect?$timeout(function(){window.location.href=$scope.campaign.contribution_redirect},5e3):"undefined"!=typeof $scope.site_campaign_pledge_redirect&&$scope.site_campaign_pledge_redirect.toggle&&$timeout(function(){window.location.href=$scope.site_campaign_pledge_redirect.url},5e3)},function(failed){$("#pledgebutton").removeClass("disabled"),errorHandling(failed),$rootScope.scrollToError()})},function(failed){$("#pledgebutton").removeClass("disabled"),errorHandling(failed)})},$scope.resolvePromiseChain=function(promises,pledgeAttributes,businessData){$q.all(promises).then(function(resolved){$scope.site_stripe_tokenization_settings.toggle;var stripe_card_id=null;angular.forEach(resolved,function(value){value.stripe_account_id&&(stripe_card_id=value.cards[0].id),value.address_id&&($scope.selectedAddressID=value.address_id),value.business_organization_id&&($scope.selectedCompanyID=value.business_organization_id)}),$scope.forceAnonymousPledge&&($scope.anonymous_contribution=1);var data={stripe_account_card_id:stripe_card_id,pledge_level_id:$scope.pledgeLevel,amount:$scope.totalAmount,shipping_address_id:$scope.selectedAddressID||"",phone_number_id:$scope.chosenPhoneNumberId,inline_token:$scope.registering_user.inline_token,anonymous_contribution:$scope.anonymous_contribution,anonymous_contribution_partial:$scope.partial_anonymous_contribution,attributes:JSON.stringify(pledgeAttributes)};$scope.acceptExtraPledgeData&&2==$scope.selectAccountCaptureType&&businessData&&(data.business_organization_id=parseInt(businessData.business_id),data.shipping_address_id=parseInt(businessData.address_id),data.phone_number_id=parseInt(businessData.phone_id)),$scope.contributionMessage&&(data.note=$scope.contributionMessage),$scope.tippingOptions.toggle&&$scope.tip.dollar_amount&&0!=$scope.tip.dollar_amount&&(data.amount_tip=parseFloat($scope.tip.dollar_amount).toFixed(2),$scope.tippingOptions.toggle_process_tips_immediately&&(data.force_tip_processing=!0)),Restangular.one("campaign",$scope.campaign_id).one("pledge").customPOST(data).then(function(success){$translate(["guest_contribution_thankyou_message"]).then(function(value){msg={header:value.guest_contribution_thankyou_message},$rootScope.floatingMessage=msg,$scope.hideFloatingMessage()}),$(".pledge-thank-you").modal({selector:{close:".actions .button",deny:".actions .negative, .actions .deny, .actions .cancel, .close"},closable:!1}).modal("show"),$scope.public_settings.site_campaign_ecommerce_analytics&&$scope.public_settings.site_campaign_ecommerce_analytics.toggle&&sendGATransaction(success,$scope.public_settings.site_campaign_ecommerce_analytics.code),"undefined"!=typeof $scope.campaign.settings&&$scope.campaign.contribution_redirect?$timeout(function(){window.location.href=$scope.campaign.contribution_redirect},5e3):"undefined"!=typeof $scope.site_campaign_pledge_redirect&&$scope.site_campaign_pledge_redirect.toggle&&$timeout(function(){window.location.href=$scope.site_campaign_pledge_redirect.url},5e3)},function(failed){2!=$scope.guestOption&&4!=$scope.guestOption||Restangular.one("account/person-inline-disable").customPUT({person_id:$scope.registering_user.id,inline_token:$scope.registering_user.inline_token}),$("#pledgebutton").removeClass("disabled"),errorHandling(failed),$timeout(function(){var accountEmail=$scope.accountInfo.email,accountPassword=$scope.accountInfo.password;$scope.accountInfo.email=accountEmail,$scope.accountInfo.password=accountPassword})})},function(failed){2!=$scope.guestOption&&4!=$scope.guestOption||Restangular.one("account/person-inline-disable").customPUT({person_id:$scope.registering_user.id,inline_token:$scope.registering_user.inline_token}),$("#pledgebutton").removeClass("disabled"),errorHandling(failed),$timeout(function(){var accountEmail=$scope.accountInfo.email,accountPassword=$scope.accountInfo.password;$scope.accountInfo.email=accountEmail,$scope.accountInfo.password=accountPassword})})},$scope.stripeExtraDetailsValidation=function(){var translation=$translate.instant(["guest_contribution_name_on_card_required"]);$(".stripe-credit-card-form.ui.form").form({name_card:{identifier:"namecard",rules:[{type:"empty",prompt:translation.guest_contribution_name_on_card_required}]}},{inline:!0,onSuccess:function(){$scope.valcheck=!0},onFailure:function(){$scope.valcheck=!1}}).form("validate form")},$scope.generalLoginValidation=function(){var translation=$translate.instant(["guest_contribution_email_error","guest_contribution_password_error","guest_contribution_new_email_error","guest_contribution_new_email_error2"]);$(".general-login-info-form.ui.form").form({email:{identifier:"email",rules:[{type:"empty",prompt:translation.guest_contribution_new_email_error},{type:"email",prompt:translation.guest_contribution_new_email_error2}]},password:{identifier:"password",rules:[{type:"empty",prompt:translation.guest_contribution_password_error}]}},{inline:!0,onSuccess:function(){$scope.valcheck=!0},onFailure:function(){$scope.valcheck=!1}}).form("validate form")},$scope.loginUser=function(){if($scope.generalLoginValidation(),$scope.accountInfo){var data={password:$scope.accountInfo.password,email:$scope.accountInfo.email};if(!$scope.valcheck)return;Restangular.one("authenticate").customPOST(data).then(function(success){var login_user=success;UserService.setLoggedIn(login_user),$scope.isEnableContributionMessage&&($rootScope.contributionMessage=$scope.contributionMessage),$scope.charity&&($rootScope.charity=$scope.charity),$location.path("/pledge-campaign")},function(failed){msg={header:"Invalid_credentials"},$rootScope.floatingMessage=msg})}},$scope.gotolink=function(path){if(2==$scope.guestOption){var data={email:$scope.accountInfo.email,password:$scope.accountInfo.password};Restangular.one("authenticate").customPOST(data).then(function(success){var login_user=success;UserService.setLoggedIn(login_user),$location.path(path)},function(failed){msg={header:failed.data.errors},$rootScope.floatingMessage=msg})}else 3==$scope.guestOption?$location.path(path):4==$scope.guestOption&&$location.path(path)},$scope.openModalById=function(id){$(".ui.modal#"+id).modal("show")},$scope.cities=[],$scope.searchCities=function(term){var native_lookup=1==$scope.native_lookup?1:0;term&&($scope.alt_shipping?Geolocator.searchCitiesBySubcountry(term,$scope.selectedSubcountry.selected.id,native_lookup).then(function(cities){if($scope.cities=cities,!cities||cities instanceof Array&&0===cities.length)Geolocator.searchCitiesBySubcountry(term,$scope.selectedSubcountry.selected.id,0).then(function(cities){$scope.cities=cities});else if(native_lookup){for(var i in cities)null!=cities[i].city_native_name&&(cities[i].name=cities[i].city_native_name),null!=cities[i].country_native_name&&(cities[i].country=cities[i].country_native_name),null!=cities[i].subcountry_native_name&&(cities[i].subcountry=cities[i].subcountry_native_name);$scope.cities=cities}}):Geolocator.searchCities(term,native_lookup).then(function(cities){$scope.cities=cities}))},$scope.randomPasswordGenerator=function(){for(var length=8,charset="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",retVal="",i=0,n=charset.length;i<length;++i)retVal+=charset.charAt(Math.floor(Math.random()*n));return retVal},$scope.shippingOptionString=function(shipOpID){1==shipOpID?$translate("Worldwide Shipping").then(function(value){$scope.shipping_option=value}):2==shipOpID?$translate("Country Specific Shipping").then(function(value){$scope.shipping_option=value}):$translate("SubCountry Specific Shipping").then(function(value){$scope.shipping_option=value})},$scope.setCountry=function(country){$scope.selectedCountry.selected=country},$scope.citySelect=function(city){chooseShipping(city)},$scope.$watch("selectedCity.selected",function(value,oldValue){if(value!=oldValue&&value){cityID=Geolocator.lookupCityID(value.name);var address_breakdown=value.name.split(",");$scope.stripeExtraDetails.address_city=address_breakdown[0],$scope.stripeExtraDetails.address_country=address_breakdown[2],cityID&&($scope.address.city_id=cityID),countryID=Geolocator.lookupCountryID(value.name),countryID&&($scope.address.country_id=countryID),$scope.citySelect(value),$("#select-city .select-error").remove(),$("#select-city").removeClass("error")}}),$scope.$watch("selectedCountry.selected",function(value,oldValue){value!=oldValue&&value&&($scope.selectedReward&&chooseShipping(value),$scope.selectedCity.selected=void 0,$scope.selectedSubcountry.selected=void 0,getSubcountries(value.id))}),$scope.$watch("selectedSubcountry.selected",function(value,oldValue){value!=oldValue&&chooseShipping(value)}),$scope.$watch("address.country_id",function(countryID){var worldWide=null,country=null;countryID&&(angular.forEach($scope.shippingOption,function(item,key){item.country_id==countryID&&(country=key),1==item.shipping_option_type_id&&(worldWide=key)}),null!=country?$scope.costIndex=country:null!=worldWide&&($scope.costIndex=worldWide))}),$scope.goBackToCampaign=function(){try{window.location.href=$scope.campaign.uri_paths[0].path}catch(e){console.error(e)}},$scope.total=function(shipping,tip){if(shipping?$scope.totalAmount=parseFloat($scope.pledgeAmount)+parseFloat(shipping):$scope.totalAmount=$scope.pledgeAmount,tip)return $scope.totalAmountPlusTip=parseFloat($scope.totalAmount)+parseFloat(tip),$scope.totalAmountPlusTip;var total=parseFloat($scope.totalAmount);return total};var m_names=new Array("January","February","March","April","May","June","July","August","September","October","November","December"),currdate=new Date;$scope.currdate=m_names[currdate.getMonth()]+" "+currdate.getDate()+" "+currdate.getFullYear()+" "+currdate.getHours()+":"+currdate.getMinutes(),$scope.$watch("campaignFundingGoal.value",function(newValue,oldValue){if(newValue!=oldValue&&newValue&&$scope.campaign&&"string"==typeof newValue&&($scope.pledgeAmount=$rootScope.formatFundingGoal(newValue),"tiers"==$scope.selectedTipType&&$scope.updateTierValues(),$scope.tip.value&&0!=$scope.tip.value&&"Percent"==$scope.tip.type)){var index=$routeParams.tipindex?$routeParams.tipindex:0,tipAmount=$scope.tippingOptions.tiers[index].dollar_amount;if(angular.forEach($scope.tippingOptions.tiers,function(value,key,obj){$scope.tip.index==key&&(tipAmount=value.dollar_amount)}),$scope.tip.dollar_amount=tipAmount,$scope.tippingOptions.toggle_tier_names)var percentString=$scope.tip.name+" - ";else var percentString="";percentString+=$filter("formatCurrency")(tipAmount,$scope.tipInfo.code_iso4217_alpha,$scope.public_setting.site_campaign_decimal_option),$(".tip-tiers").dropdown("set text",percentString)}}),$scope.$watch("guestOption",function(value,oldValue){value!=oldValue&&1!=value&&setTimeout(function(){$scope.newNumberCreated.number||$scope.newNumberCreated.phonetype||$("#phone_type_Landline").click(),$scope.newNumberCreated.phonetype&&$("#phone_type_"+$scope.newNumberCreated.phonetype.name).click()},100)}),$scope.forgotPassword=function(){$(".forgot-password-modal").modal({onApprove:function(){if(!$(".ui.email.form").form("validate form"))return!1}}).modal("show")},$scope.resetPassword=function(){if($(".ui.email.form").form("validate form")){var data={email:$scope.email};Restangular.one("authenticate").one("forgot").customPOST(data).then(function(success){success.success?(msg={header:"email_sent"},$rootScope.floatingMessage=msg):msg={header:"wrong_email_sent"},$rootScope.floatingMessage=msg})}},$scope.tipTypeSelection=function(type){if($scope.tipTypeError=!1,$scope.tip={value:null,dollar_amount:0,type:"Dollar"},"tiers"==type){if($scope.tippingOptions.tiers[0]){$scope.updateTierValues(),$scope.tip={value:$scope.tippingOptions.tiers[0].value,dollar_amount:$scope.tippingOptions.tiers[0].dollar_amount,type:$scope.tippingOptions.tiers[0].type,name:$scope.tippingOptions.tiers[0].name,index:0},$scope.tipTiersDefaultName=$scope.tippingOptions.toggle_tier_names?$scope.tippingOptions.tiers[0].name:"",$scope.tipTiersDefaultAmount=$scope.tippingOptions.tiers[0].dollar_amount;var percentString=$scope.tipTiersDefaultName+" - "+$filter("formatCurrency")($scope.tipTiersDefaultAmount,$scope.tipInfo.code_iso4217_alpha,$scope.public_setting.site_campaign_decimal_option);$(".tip-tiers").dropdown("set text",percentString)}}else"dynamic"==type&&$scope.tippingOptions.toggle_dynamic_min_max&&$scope.tippingOptions.dynamic_min&&($scope.tip.value=$scope.tippingOptions.dynamic_min,$scope.tip.dollar_amount=$scope.tippingOptions.dynamic_min);$scope.selectedTipType=type},$scope.tipTierSelection=function(value,type,dollarAmount,name,index){$scope.tip={value:parseFloat(value),dollar_amount:parseFloat(dollarAmount),type:type,name:name,index:index}},$scope.updateTierValues=function(){angular.forEach($scope.tippingOptions.tiers,function(value){"Percent"==value.type?value.dollar_amount=value.value/100*$scope.pledgeAmount:value.dollar_amount=value.value,value.dollar_amount<$scope.lowestAmount&&(value.dollar_amount+=$scope.lowestAmount)})},$scope.scrollToRewardParam=function(){$location.search({}),$location.path($scope.campaign_loc).search("scroll_to_reward",1)}}]);