app.controller("TransactionDetailsCtrl",["$scope","$q","$routeParams","$timeout","Restangular","RestFullResponse","$translatePartialLoader","$translate","RESOURCE_REGIONS","LANG",function($scope,$q,$routeParams,$timeout,Restangular,RestFullResponse,$translatePartialLoader,$translate,RESOURCE_REGIONS,LANG){function renderSummaryChart(){var ctx=$("#campaign-transaction-chart").get(0).getContext("2d"),transaction_chart=new Chart(ctx),data={labels:["Total new pre auth","Total pre auth success","Total pre auth failure","Total new captures","Total capture success","Total capture failure"],datasets:[{data:[parseInt($scope.transaction_summary.total_pre_auth_new),parseInt($scope.transaction_summary.total_pre_auth_success),parseInt($scope.transaction_summary.total_pre_auth_failure),parseInt($scope.transaction_summary.total_capture_new),parseInt($scope.transaction_summary.total_capture_success),parseInt($scope.transaction_summary.total_capture_failure)],fillColor:"rgba(151,187,205,0.5)",strokeColor:"rgba(151,187,205,0.8)",highlightFill:"rgba(151,187,205,0.75)",highlightStroke:"rgba(151,187,205,1)"}]};return transaction_chart.Bar(data)}$scope.RESOURCE_REGIONS=RESOURCE_REGIONS;var campaign_id=$routeParams.campaign_id,globalPhoneNumberType={},globalStripeStatus=[],globalStripeType=[];$translate(["Landline Phone Number","Mobile Phone Number","Fax Phone Number"]).then(function(phoneNumberType){globalPhoneNumberType=phoneNumberType}),$translate(["stripe_status_status_new_ready_process","stripe_status_status_new_being_processed","stripe_status_status_processed_success","stripe_status_status_processed_failure","stripe_status_type_pledge_preauth","stripe_status_type_pledge_capture"]).then(function(stripeTranslation){for(var stripeResp in stripeTranslation)stripeTranslation.hasOwnProperty(stripeResp)&&(globalStripeStatus.length<4?globalStripeStatus.push(stripeTranslation[stripeResp]):globalStripeType.push(stripeTranslation[stripeResp]))}),campaign_id?Restangular.one("campaign").customGET(campaign_id).then(function(success){$scope.campaign=success,$scope.$emit("loading_finished")}):$scope.$emit("loading_finished"),$scope.filename="detail",$scope.data=[],$scope.showContact=function(index){var nativeLookup=$scope.public_settings.site_theme_shipping_native_lookup;if(null!=$scope.transaction_detail[index].backer[0].person[0].person_shipping_phone_number){var phoneNumber=$scope.transaction_detail[index].backer[0].person[0].person_shipping_phone_number[0].number,phoneType=$scope.transaction_detail[index].backer[0].person[0].person_shipping_phone_number[0].phone_number_type;$scope.shippingPhoneNumber=phoneNumber,$scope.shippingPhoneType=phoneType}if($scope.address=$scope.transaction_detail[index].backer[0].person[0].person_shipping_address,$scope.alt_shipping){if($scope.alt_shipping){var name=$scope.transaction_detail[index].backer[0].person[0].first_name+" "+$scope.transaction_detail[index].backer[0].person[0].last_name,city=null!=$scope.address[0].city_native_name&&nativeLookup?$scope.address[0].city_native_name:$scope.address[0].city,country=null!=$scope.address[0].country_native_name&&nativeLookup?$scope.address[0].country_native_name:$scope.address[0].country,street=$scope.address[0].street1,mailcode=$scope.address[0].mail_code,subcountry=null!=$scope.address[0].subcountry_native_name&&nativeLookup?$scope.address[0].subcountry_native_name:$scope.address[0].subcountry,address=subcountry+", "+city;if($scope.address[0].city_alt&&$scope.public_settings.site_campaign_alt_city_input_toggle)var address=subcountry+", "+$scope.address[0].city_alt;$("#backername").text(name),$("#postcode").text(mailcode),$("#street").text(street),$("#main_address").text(address),$("#country_name").text(country)}}else{var name=$scope.transaction_detail[index].backer[0].person[0].first_name+" "+$scope.transaction_detail[index].backer[0].person[0].last_name,city=null!=$scope.address[0].city_native_name&&nativeLookup?$scope.address[0].city_native_name:$scope.address[0].city,country=null!=$scope.address[0].country_native_name&&nativeLookup?$scope.address[0].country_native_name:$scope.address[0].country,street=$scope.address[0].street1,mailcode=$scope.address[0].mail_code,subcountry=null!=$scope.address[0].subcountry_native_name&&nativeLookup?$scope.address[0].subcountry_native_name:$scope.address[0].subcountry,address=city+", "+subcountry+" "+mailcode;if($scope.address[0].city_alt&&$scope.public_settings.site_campaign_alt_city_input_toggle)var address=$scope.address[0].city_alt+", "+subcountry+" "+mailcode;$("#backername").text(name),$("#street").text(street),$("#main_address").text(address),$("#country_name").text(country)}$(".small.test.modal").modal("show")},Restangular.one("portal/setting").getList().then(function(success){$scope.public_settings={},angular.forEach(success,function(value){3==value.setting_type_id&&($scope.public_settings[value.name]=value.value,$scope.payment_gateway=$scope.public_settings.site_payment_gateway)}),$scope.alt_shipping=$scope.public_settings.site_theme_alt_shipping_layout,1==$scope.payment_gateway?(Restangular.one("campaign/"+campaign_id+"/stats").customGET(null,{summary:1}).then(function(success){$scope.transaction_summary=success,renderSummaryChart()}),RestFullResponse.all("campaign/"+campaign_id+"/stats").getList($scope.transaction_pagination).then(function(success){$scope.transaction_detail=success.data,$scope.na="";var headers=success.headers();headers["x-pager-total-entries"]?$scope.transaction_length=headers["x-pager-total-entries"]:$scope.transaction_length="0",$scope.transaction_pagination.currentpage=headers["x-pager-current-page"],$scope.transaction_pagination.numpages=headers["x-pager-last-page"],$scope.transaction_pagination.nextpage=headers["x-pager-next-page"],$scope.transaction_pagination.pagesinset=headers["x-pager-pages-in-set"],$scope.transaction_pagination.totalentries=headers["x-pager-total-entries"],$scope.transaction_pagination.entriesperpage=headers["x-pager-entries-per-page"]})):(Restangular.one("campaign/"+campaign_id+"/stats").customGET(null,{summary:1,use_widgetmakr:1}).then(function(success){$scope.transaction_summary=success,renderSummaryChart()}),Restangular.one("campaign/"+campaign_id+"/stats").customGET(null,{summary:0,use_widgetmakr:1}).then(function(success){$scope.transaction_detail=success,$scope.na=""}))},function(failure){$msg={header:failure.data.message},$scope.errorMessage.push($msg)}),$scope.createTransactionCSV=function(campaign_id){var transactionRequestArray=[],totalNumTransaction=$scope.transaction_pagination.totalentries,requiredNumCalls=0;$scope.allTransactionArray=[];requiredNumCalls=parseInt(parseInt(totalNumTransaction)/100),totalNumTransaction%100!=0&&(requiredNumCalls+=1),$scope.transaction_pagination_csv={sort:"-created",page_entries:100,page_limit:150,page:1,pagination:{},summary:0};for(var curNumCall=0;curNumCall<requiredNumCalls;curNumCall++){var request=RestFullResponse.all("campaign/"+campaign_id+"/stats").getList($scope.transaction_pagination_csv);transactionRequestArray.push(request),$scope.transaction_pagination_csv.page+=1}return $q.all(transactionRequestArray).then(function(success){$scope.allTransactioncsv=[],success.forEach(function(resArr){$scope.allTransactionArray=$scope.allTransactionArray.concat(resArr.data)});var nativeLookup=$scope.public_settings.site_theme_shipping_native_lookup,value=$translate.instant(["transaction_details_withdrawn","transaction_details_card_number","transaction_details_Manual_Transaction","transaction_details_na","transaction_details_transaction_id","transaction_details_contributors_first","transaction_details_contributors_last","transaction_details_reward","transaction_details_amount","transaction_details_status","transaction_details_date","transaction_details_contributors_email","transaction_details_shipping_address","transaction_details_phone_number","transaction_details_reward_attribute","transaction_details_charity_UK_taxpayer","transaction_details_charity_giftaid","transaction_details_charity_fullname","transaction_details_charity_fulladdress","transaction_details_charity_postcode","transaction_details_charity_amount"]);return $scope.cardnum=value.transaction_details_card_number,$scope.noreward=value.transaction_details_na,$scope.tid=value.transaction_details_transaction_id,$scope.treward=value.transaction_details_reward,$scope.tamount=value.transaction_details_amount,$scope.tstatus=value.transaction_details_status,$scope.tnamef=value.transaction_details_contributors_first,$scope.tnamel=value.transaction_details_contributors_last,$scope.temail=value.transaction_details_contributors_email,$scope.tdate=value.transaction_details_date,$scope.taddress=value.transaction_details_shipping_address,$scope.tphone=value.transaction_details_phone_number,$scope.twithdraw=value.transaction_details_withdrawn,$scope.manual=value.transaction_details_Manual_Transaction,$scope.attributes=value.transaction_details_reward_attribute,$scope.csvHeaders={ID:$scope.tid,Reward:$scope.treward,Amount:$scope.tamount,Status:$scope.tstatus,"First Name":$scope.tnamef,"Last Name":$scope.tnamel,Email:$scope.temail,Card:$scope.cardnum,Date:$scope.tdate,Address:$scope.taddress,Phone:$scope.tphone,Attribute:$scope.attributes},$scope.public_settings.site_campaign_charity_helper_enable&&($scope.csvHeaders["UK Tax Payer"]=value.transaction_details_charity_UK_taxpayer,$scope.csvHeaders["Gift Aid"]=value.transaction_details_charity_giftaid,$scope.csvHeaders["Full name"]=value.transaction_details_charity_fullname,$scope.csvHeaders["Full Address"]=value.transaction_details_charity_fulladdress,$scope.csvHeaders.Postcode=value.transaction_details_charity_postcode,$scope.csvHeaders["Gift Amount"]=value.transaction_details_charity_amount),$scope.allTransactioncsv.push($scope.csvHeaders),angular.forEach($scope.allTransactionArray,function(value){var data1={};if(value.card?($scope.cardn="**** **** ****"+value.card[0].last4,$scope.tstatus=globalStripeStatus[value.stripe_transaction_status_id-1]):($scope.cardn=value.reference_no,$scope.tstatus=$scope.manual),value.backer&&(value.backer[0].disabled&&($scope.tstatus=$scope.twithdraw),value.backer[0].person)){$scope.addbacker=value.backer[0].person[0],value.backer[0].pledge_level?$scope.rewardname=value.backer[0].pledge_level[0].name:$scope.rewardname=$scope.noreward;var phoneType,phoneNumberObj=value.backer[0].person[0].person_shipping_phone_number;null!=phoneNumberObj&&(phoneType=globalPhoneNumberType[phoneNumberObj[0].phone_number_type]),$scope.dataPhoneNumber=null!=phoneNumberObj?phoneNumberObj[0].number+" "+phoneType:"";var parsedEmail=$scope.addbacker.email.split("|||")[0];$scope.addbacker.person_shipping_address?($scope.shipadd=$scope.addbacker.person_shipping_address[0],nativeLookup?($scope.shipadd.city=null!=$scope.shipadd.city_native_name?$scope.shipadd.city_native_name:$scope.shipadd.city,$scope.shipadd.subcountry=null!=$scope.shipadd.subcountry_native_name?$scope.shipadd.subcountry_native_name:$scope.shipadd.subcountry,$scope.shipadd.country=null!=$scope.shipadd.country_native_name?$scope.shipadd.country_native_name:$scope.shipadd.country,$scope.completeaddress=$scope.shipadd.country+", "+$scope.shipadd.mail_code+", "+$scope.shipadd.subcountry+", "+$scope.shipadd.city+", "+$scope.shipadd.street1):$scope.completeaddress=$scope.shipadd.street1+" , "+$scope.shipadd.city+" "+$scope.shipadd.subcountry+" "+$scope.shipadd.mail_code+" , "+$scope.shipadd.country,data1={ID:value.stripe_transaction_id,Reward:$scope.rewardname,Amount:value.backer[0].amount,Status:$scope.tstatus,"First Name":$scope.addbacker.first_name,"Last Name":$scope.addbacker.last_name,Email:parsedEmail,Card:$scope.cardn,Date:value.created.slice(0,19),Address:$scope.completeaddress,Phone:$scope.dataPhoneNumber,Attributes:JSON.stringify(value.backer[0].attributes)}):data1={ID:value.stripe_transaction_id,Reward:$scope.rewardname,Amount:value.backer[0].amount,Status:$scope.tstatus,"First Name":$scope.addbacker.first_name,"Last Name":$scope.addbacker.last_name,Email:parsedEmail,Card:$scope.cardn,Date:value.created.slice(0,19),Address:$scope.na,Phone:$scope.dataPhoneNumber,Attributes:JSON.stringify(value.backer[0].attributes)},$scope.public_settings.site_campaign_charity_helper_enable&&value.backer[0].attributes&&value.backer[0].attributes.charity&&(data1["UK Tax Payer"]=value.backer[0].attributes.charity.is_a_tax_payer,data1["Gift Aid"]=value.backer[0].attributes.charity.is_a_gift,data1["Full name"]=value.backer[0].attributes.charity.fullname,data1["Full Address"]=value.backer[0].attributes.charity.address,data1.Postcode=value.backer[0].attributes.charity.postcode,data1["Gift Amount"]=value.backer[0].charity_helper_amount),$scope.allTransactioncsv.push(data1)}}),$scope.allTransactioncsv})},$scope.transaction_pagination={sort:"-created",page_entries:100,page_limit:100,page:1,pagination:{},summary:0},$scope.getTransactions=function(index){RestFullResponse.all("campaign/"+index+"/stats").getList($scope.transaction_pagination).then(function(success){$scope.transaction_detail=success.data,$scope.na="";var headers=success.headers();headers["x-pager-total-entries"]?$scope.transaction_length=headers["x-pager-total-entries"]:$scope.transaction_length="0",$scope.transaction_pagination.currentpage=headers["x-pager-current-page"],$scope.transaction_pagination.numpages=headers["x-pager-last-page"],$scope.transaction_pagination.nextpage=headers["x-pager-next-page"],$scope.transaction_pagination.pagesinset=headers["x-pager-pages-in-set"],$scope.transaction_pagination.totalentries=headers["x-pager-total-entries"],$scope.transaction_pagination.entriesperpage=headers["x-pager-entries-per-page"]})}}]),app.filter("dateconv",["$filter",function($filter){return function(input){if(null==input)return"";var year=input.substring(0,4),month=input.substring(5,7),day=input.substring(8,10),hr=input.substring(11,13),min=input.substring(14,16),d=year+"-"+month+"-"+day+"   "+hr+":"+min;return d}}]);