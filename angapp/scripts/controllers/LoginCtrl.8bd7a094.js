app.controller("LoginCtrl",["$rootScope","$scope","PortalSettingsService","UserService","Restangular","redirectService","$translate","$translatePartialLoader","AUTH_SCHEME","$timeout",function($rootScope,$scope,PortalSettingsService,UserService,Restangular,redirectService,$translate,$translatePartialLoader,AUTH_SCHEME,$timeout){$scope.submit_once=!1,$scope.formData={},$scope.account={};var auth_scheme=AUTH_SCHEME[0],url=redirectService.getUrl(),tmp_lst=url.split("/");"authenticate"==tmp_lst[1]&&"forgot"==tmp_lst[2]&&($scope.formData.successful={message:"login_new_password"}),$scope.$watch("userEmail",function(v){$scope.formData.email||($scope.formData.email=v)}),$(".modal").modal({allowMultiple:!0}),$scope.tos_login=!1,PortalSettingsService.getSettings(!0).then(function(success){$rootScope.loginRedirect=null,$scope.val=success,angular.forEach($scope.val,function(value){value&&("site_tos_login_ui"===value.name?$scope.tos_login=value.value:"site_auth_scheme"===value.name?auth_scheme=value.value:"site_disable_account_setting"===value.name?$scope.isAccSetEnabled=!value.value:"site_login_redirect"!==value.name||$rootScope.loginRedirect||($rootScope.loginRedirect=value.value,"undefined"!=typeof $scope.loginRedirect.text&&""!==$scope.loginRedirect.text&&"undefined"!=typeof $scope.loginRedirect.link&&""!==$scope.loginRedirect.link?$scope.loginRedirectShow=!0:$scope.loginRedirectShow=!1))}),$scope.isAccSetEnabled=void 0==$scope.isAccSetEnabled||$scope.isAccSetEnabled,$scope.$emit("loading_finished")}),$rootScope.checklogin=!0,$scope.formData={},$scope.submit=function(){if($scope.tos_login){if($scope.submit_once=!0,!$('#login input[type="checkbox"]').is(":checked"))return void($scope.login_tos_not_checked=!0);$scope.login_tos_not_checked=!1}var not_validated=!$(".ui.login.form").form("validate form");not_validated||($scope.formData.errors=null,$scope.formData.successful=null,$scope.loading=!0,$scope.formData.successful={message:"login_logging_in"},$translate(["login_page_login_message"]).then(function(value){$scope.login_message=value.login_page_login_message}),$scope.formData.email||($scope.formData.email=$('#login input[name="email"]').val()),$scope.formData.password||($scope.formData.password=$('#login input[name="password"]').val()),2==auth_scheme.id&&($scope.formData.password_scheme="sha1"),Restangular.all("authenticate").post($scope.formData).then(function(success){$scope.formData.errors=null,$scope.formData.successful=null,$scope.formData.successful={message:"login_login_successful"},$translate(["login_page_login_success"]).then(function(value){$scope.login_message=value.login_page_login_success}),UserService.setLoggedIn(success),$(".ui.modal").modal("hide")},function(failure){$scope.formData.errors=null,$scope.formData.successful=null,$scope.formData.errors=failure.data.errors,$scope.formData.error_message=failure.data.message,$scope.str=$scope.formData.errors.credential_verification[0].code,"authenticate_invalid_authenticate_credentials"===$scope.str&&$translate("login_page_invalid_credentials").then(function(value){$scope.invalid_cred=value}),$scope.loading=!1}))},$scope.serrormessgae="",$timeout(function(){$translate(["login_page_invalid_email","login_page_empty_email","login_page_password_empty","login_page_password_length"]).then(function(value){$scope.email_empty_invalid=value.login_page_invalid_email,$scope.email_empty=value.login_page_empty_email,$scope.password_empty=value.login_page_password_empty,$scope.password_length=value.login_page_password_length,$(".ui.login.form").form({email:{identifier:"email",rules:[{type:"empty",prompt:$scope.email_empty},{type:"email",prompt:$scope.email_empty_invalid}]},password:{identifier:"password",rules:[{type:"empty",prompt:$scope.password_empty},{type:"length[6]",prompt:$scope.password_length}]}},{inline:!0})})},1e3),$scope.forgotPassword=function(){$(".forgot-password-modal").modal({onApprove:function(){if(!$(".ui.email.form").form("validate form"))return!1}}).modal("show")},$scope.resetPassword=function(){if($scope.isAccSetEnabled){if(!$(".ui.email.form").form("validate form"))return;var data={email:$scope.account.email};Restangular.one("authenticate").one("forgot").customPOST(data).then(function(success){success.success?$rootScope.emailconfirmed=!0:$rootScope.wrongemail=!0})}},$scope.reconfirm=function(){if($(".ui.email.form").form("validate form")){var data={email:$scope.account.email};Restangular.one("register").one("reconfirm").customPOST(data).then(function(success){success.success?$rootScope.emailconfirmed=!0:$rootScope.wrongemail=!0})}};var translationLogin=$translate.instant(["login_emailempty_prompt","login_emailinvalid_prompt"]);$(".ui.email.form").form({email:{identifier:"email",rules:[{type:"empty",prompt:translationLogin.login_emailempty_prompt},{type:"email",prompt:translationLogin.login_emailinvalid_prompt}]}},{inline:!0,on:"blur",onInvalid:function(){this.hasClass("ng-pristine")&&(this.parent().removeClass("error"),this.next().remove())}})}]);